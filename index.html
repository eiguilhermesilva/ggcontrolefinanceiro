<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GG - Controle Financeiro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
    background: linear-gradient(135deg, #2C3E50, #2C3E50, #409EDD);
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 20px;
    min-height: 100vh;
}

.financial-widget {
    background-color: #ffffff;
    border-radius: 10px;
    box-shadow: 10 10px 10px rgba(255, 255, 255, 0);
    width: 100%;
    max-width: 1350px;
    padding: 25px;
    position: relative;
    padding-bottom: 100px;
    overflow: hidden;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 25px;
    border-bottom: 2px solid #f0f2f5;
    position: relative;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 15px;
}

h1 {
    color: #2c3e50;
    font-size: 1.9em;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
}

h1 i {
    color: #3498db;
}

.date-display {
    background: #f8f9fa;
    padding: 8px 20px;
    border-radius: 30px;
    font-weight: 600;
    color: #2c3e50;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    font-size: 0.9em;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* NOVO: Abas de navegação */
.tabs {
    display: flex;
    margin-bottom: 25px;
    background: #f8f9fa;
    border-radius: 10px;
    padding: 5px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.tab {
    flex: 1;
    padding: 12px 20px;
    text-align: center;
    cursor: pointer;
    border-radius: 8px;
    font-weight: 600;
    color: #7f8c8d;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.tab.active {
    background: white;
    color: #2c3e50;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.tab i {
    font-size: 1.1em;
}

/* NOVO: Container de conteúdo das abas */
.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.input-section {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 30px;
    align-items: flex-end;
    background: #f8f9fa;
    padding: 25px;
    border-radius: 12px;
}

.input-group {
    flex: 1;
    min-width: 200px;
}

.input-group label {
    display: block;
    margin-bottom: 8px;
    color: #555;
    font-weight: 500;
    font-size: 0.95em;
}

.input-group input, 
.input-group select {
    width: 100%;
    padding: 14px;
    border: 1px solid #dfe6e9;
    border-radius: 8px;
    font-size: 1em;
    color: #34495e;
    transition: all 0.3s ease;
    background-color: white;
}

.date-input-container {
    position: relative;
    display: flex;
}

.date-input {
    width: 100%;
    padding: 14px;
    border: 1px solid #dfe6e9;
    border-radius: 8px;
    font-size: 1em;
    color: #34495e;
    transition: all 0.3s ease;
    background-color: white;
}

.input-group input:focus,
.input-group select:focus,
.date-input:focus {
    border-color: #3498db;
    outline: none;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
}

.input-actions {
    display: flex;
    gap: 10px;
    flex-grow: 1;
    justify-content: flex-end;
    flex-wrap: wrap;
}

.btn {
    padding: 14px 20px;
    border: none;
    border-radius: 8px;
    font-size: 0.95em;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    color: white;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.btn-income {
    background: linear-gradient(to right, #27ae60, #2ecc71);
}

.btn-income:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(46, 204, 113, 0.3);
}

.btn-expense {
    background: linear-gradient(to right, #e74c3c, #ff6b6b);
}

.btn-expense:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(231, 76, 60, 0.3);
}

.btn-edit {
    background: linear-gradient(to right, #3498db, #5dade2);
    color: white;
    padding: 8px 15px;
    font-size: 0.9em;
}

.btn-edit:hover {
    background: linear-gradient(to right, #2980b9, #3498db);
}

.btn-delete {
    background: linear-gradient(to right, #e74c3c, #ff6b6b);
    color: white;
    padding: 8px 15px;
    font-size: 0.9em;
}

.btn-delete:hover {
    background: linear-gradient(to right, #c0392b, #e74c3c);
}

.btn-update {
    background: linear-gradient(to right, #9b59b6, #8e44ad);
}

.btn-update:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(155, 89, 182, 0.3);
}

.btn-cancel {
    background: linear-gradient(to right, #95a5a6, #7f8c8d);
}

.btn-cancel:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(149, 165, 166, 0.3);
}

.btn-pdf {
    background: linear-gradient(to right, #e74c3c, #ff6b6b);
    width: 100%;
    margin-top: 15px;
    padding: 14px;
    font-size: 1.0em;
    justify-content: center;
}

.btn-json {
    background: linear-gradient(to right, #f39c12, #f1c40f);
    width: 100%;
    margin-top: 15px;
    padding: 14px;
    font-size: 1.0em;
    justify-content: center;
}

.btn-import {
    background: linear-gradient(to right, #8e44ad, #9b59b6);
    width: 100%;
    margin-top: 15px;
    padding: 14px;
    font-size: 1.0em;
    justify-content: center;
}

.btn-whatsapp {
    background: linear-gradient(to right, #128C7E, #128C7E);
    width: 100%;
    margin-top: 15px;
    padding: 14px;
    font-size: 1.0em;
    justify-content: center;
}

.btn-whatsapp:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(37, 211, 102, 0.3);
}

/* NOVO: Estilos para a seção de configurações */
.settings-section {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 30px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e6ed;
}

.settings-title {
    color: #2c3e50;
    font-size: 1.4em;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
}

.settings-description {
    color: #7f8c8d;
    margin-bottom: 25px;
    font-size: 0.95em;
}

.recurring-transactions {
    margin-top: 20px;
}

.recurring-transactions-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.recurring-transactions-header h3 {
    color: #2c3e50;
    font-size: 1.2em;
    display: flex;
    align-items: center;
    gap: 10px;
}

.recurring-transactions-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.recurring-transaction-item {
    background: white;
    border-radius: 10px;
    padding: 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border-left: 4px solid #3498db;
    transition: transform 0.2s ease;
}

.recurring-transaction-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
}

.recurring-transaction-item.income {
    border-left-color: #27ae60;
}

.recurring-transaction-item.expense {
    border-left-color: #e74c3c;
}

.recurring-transaction-info {
    flex: 1;
}

.recurring-transaction-name {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.recurring-transaction-details {
    display: flex;
    gap: 15px;
    font-size: 0.9em;
    color: #7f8c8d;
}

.recurring-transaction-value {
    font-weight: 600;
    color: #2c3e50;
}

.recurring-transaction-actions {
    display: flex;
    gap: 10px;
}

.recurring-transaction-empty {
    text-align: center;
    padding: 30px;
    color: #95a5a6;
    font-style: italic;
}

.btn-add-recurring {
    background: linear-gradient(to right, #3498db, #5dade2);
    margin-top: 10px;
}

.btn-add-recurring:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(52, 152, 219, 0.3);
}

.btn-apply-recurring {
    background: linear-gradient(to right, #27ae60, #2ecc71);
    width: 100%;
    margin-top: 20px;
    justify-content: center;
}

.btn-apply-recurring:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(46, 204, 113, 0.3);
}

/* NOVO: Modal para adicionar transação recorrente */
.recurring-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2001;
    display: none;
}

.recurring-modal {
    background: white;
    border-radius: 12px;
    padding: 25px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.recurring-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.recurring-modal-header h2 {
    color: #2c3e50;
    font-size: 1.5em;
    display: flex;
    align-items: center;
    gap: 10px;
}

.close-recurring-modal {
    background: none;
    border: none;
    font-size: 1.5em;
    cursor: pointer;
    color: #7f8c8d;
}

.recurring-modal-content {
    margin-bottom: 20px;
}

.recurring-type-selector {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.recurring-type-btn {
    flex: 1;
    padding: 12px;
    border: 2px solid #dfe6e9;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    font-weight: 600;
    color: #7f8c8d;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.recurring-type-btn.active {
    border-color: #3498db;
    color: #3498db;
    background: rgba(52, 152, 219, 0.1);
}

.recurring-type-btn.income.active {
    border-color: #27ae60;
    color: #27ae60;
    background: rgba(39, 174, 96, 0.1);
}

.recurring-type-btn.expense.active {
    border-color: #e74c3c;
    color: #e74c3c;
    background: rgba(231, 76, 60, 0.1);
}

.summary-section {
    display: flex;
    justify-content: space-around;
    padding: 0; 
    background: none;
    border-radius: 0;
    box-shadow: none;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 20px;
}

.summary-item {
    text-align: center;
    min-width: 200px;
    flex: 1;
    padding: 15px;
    border-radius: 10px;
    background: white;
    box-shadow: 0 3px 10px rgba(0,0,0,0.08);
}

.summary-item h3 {
    color: #7f8c8d;
    font-size: 0.95em;
    margin-bottom: 10px;
}

.summary-item p {
    font-size: 1.5em;
    font-weight: 700;
    margin: 5px 0 0;
}

#total-income {
    color: #3799DB;
}

#total-expense {
    color: #e74c3c;
}

#current-balance {
    color: #3498db;
}

#total-paid {
    color: #2c3e50;
}

#total-pending {
    color: #2c3e50;
}

.transactions-section {
    background: #ffffff;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 30px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    overflow-x: auto;
}

.transactions-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f0f2f5;
}

.transactions-title {
    color: #2c3e50;
    font-size: 1.2em;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
}

.transactions-count {
    background: #3498db;
    color: white;
    border-radius: 50%;
    width: 26px;
    height: 26px;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    font-size: 0.9em;
    margin-left: 8px;
}

.transactions-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin-top: 10px;
}

.transactions-table th {
    background-color: #2c3e50;
    color: white;
    font-weight: 500;
    text-transform: uppercase;
    font-size: 0.80em;
    padding: 12px 10px;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 10;
}

.transactions-table th:first-child {
    border-radius: 8px 0 0 0;
}

.transactions-table th:last-child {
    border-radius: 0 8px 0 0;
}

.transactions-table td {
    color: #34495e;
    padding: 12px 10px;
    border-bottom: 1px solid #f0f2f5;
    font-size: 0.9em;
    vertical-align: middle;
}

.transactions-table tbody tr:nth-child(even) {
    background-color: #f9fafb;
}

.transactions-table tbody tr:hover {
    background-color: #f0f7ff;
}

.transactions-table tbody tr:last-child td {
    border-bottom: none;
}

.type-income {
    color: #27ae60;
    font-weight: 500;
    background: rgba(39, 174, 96, 0.1);
    padding: 5px 10px;
    border-radius: 20px;
    display: inline-block;
    font-size: 0.85em;
    white-space: nowrap;
}

.type-expense {
    color: #e74c3c;
    font-weight: 500;
    background: rgba(231, 76, 60, 0.1);
    padding: 5px 10px;
    border-radius: 20px;
    display: inline-block;
    font-size: 0.85em;
    white-space: nowrap;
}

.category-badge {
    font-size: 0.85em;
    padding: 5px 10px;
    border-radius: 12px;
    background: #f1f2f6;
    color: #2f3542;
    font-weight: 500;
    display: inline-block;
    white-space: nowrap;
}

.date-cell {
    white-space: nowrap;
    color: #7f8c8d;
    font-size: 0.85em;
}

.action-cell {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
}

.charts-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    margin-bottom: 20px;
}

.charts-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
    margin-top: 10px;
}

.chart-container {
    width: 100%;
    max-width: 450px;
    height: 350px;
    background-color: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.chart-title {
    color: #2c3e50;
    font-size: 1.0em;
    font-weight: 500;
}

.chart-actions {
    display: flex;
    gap: 10px;
}

.chart-btn {
    background: #3498db;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 6px 10px;
    cursor: pointer;
    font-size: 0.85em;
}

.financial-health-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
}

.health-message {
    padding: 15px 20px;
    border-radius: 8px;
    text-align: center;
    font-size: 1.1em;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
}

.health-message i {
    font-size: 1.5em;
}

.health-positive {
    background: linear-gradient(to right, rgba(39, 174, 96, 0.15), rgba(46, 204, 113, 0.15));
    color: #27ae60;
    border-left: 5px solid #27ae60;
}

.health-neutral {
    background: linear-gradient(to right, rgba(241, 196, 15, 0.15), rgba(243, 156, 18, 0.15));
    color: #f39c12;
    border-left: 5px solid #f39c12;
}

.health-warning {
    background: linear-gradient(to right, rgba(230, 126, 34, 0.15), rgba(211, 84, 0, 0.15));
    color: #e67e22;
    border-left: 5px solid #e67e22;
}

.health-critical {
    background: linear-gradient(to right, rgba(231, 76, 60, 0.15), rgba(192, 57, 43, 0.15));
    color: #e74c3c;
    border-left: 5px solid #e74c3c;
}

.widget-footer {
    text-align: center;
    margin-top: 30px;
    color: #7f8c8d;
    font-size: 0.9em;
    padding-top: 10px;
    border-top: 1px solid #eee;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding-bottom: 15px;
    background-color: #ffffff;
}

.edit-mode-banner {
    background: linear-gradient(to right, #9b59b6, #8e44ad);
    color: white;
    padding: 10px;
    text-align: center;
    border-radius: 8px;
    margin-bottom: 15px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.action-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    width: 100%;
    margin-top: 15px;
}

.error-message {
    color: #e74c3c;
    font-size: 0.8em;
    margin-top: 5px;
    display: none;
}

.input-group.error input,
.input-group.error select {
    border-color: #e74c3c;
}

.export-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.export-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 25px;
    border-radius: 8px;
    background: #2ecc71;
    color: white;
    font-weight: 600;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    z-index: 1000;
    display: none;
    animation: slideIn 0.3s, fadeOut 0.5s 2.5s;
}

.import-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    display: none;
}

.import-modal {
    background: white;
    border-radius: 12px;
    padding: 25px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.modal-header h2 {
    color: #2c3e50;
    font-size: 1.5em;
}

.close-modal {
    background: none;
    border: none;
    font-size: 1.5em;
    cursor: pointer;
    color: #7f8c8d;
}

.modal-content {
    margin-bottom: 20px;
}

.modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.file-input-wrapper {
    position: relative;
    margin: 15px 0;
}

.file-label {
    display: block;
    padding: 12px 15px;
    background: #f8f9fa;
    border: 2px dashed #3498db;
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.file-label:hover {
    background: #e3f2fd;
}

.file-label i {
    font-size: 2em;
    color: #3498db;
    margin-bottom: 10px;
}

.file-input {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

.file-name {
    margin-top: 10px;
    font-size: 0.9em;
    color: #555;
    text-align: center;
}

@keyframes slideIn {
    from { right: -300px; opacity: 0; }
    to { right: 20px; opacity: 1; }
}

@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}

.back-to-top {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(to right, #2A82BC, #3396D9);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2em;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    z-index: 999;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s ease;
}

.back-to-top.visible {
    opacity: 1;
    transform: translateY(0);
}

.back-to-top:hover {
    background: linear-gradient(to right, #2C3E50, #34485c);
    transform: translateY(-3px);
}

.in-app-reminder {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #2c3e50;
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: opacity 0.3s;
}

.reminder-content {
    display: flex;
    align-items: center;
    gap: 10px;
}

.close-reminder {
    background: none;
    border: none;
    color: white;
    font-size: 1.2em;
    cursor: pointer;
    margin-left: 10px;
}

#real-balance {
    font-weight: 700;
    font-size: 1.4em;
}

.notification-settings {
    position: relative;
    display: inline-block;
}

.notification-icon {
    width: 0px;
    height: 0px;
    border-radius: 50%;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #2c3e50;
    font-size: 1.2rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.notification-icon:hover {
    background: #e3f2fd;
    transform: scale(1.1);
}

.notification-options-container {
    position: absolute;
    top: 100%;
    right: 0;
    width: 280px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    padding: 15px;
    z-index: 1000;
    display: none;
    margin-top: 10px;
}

.notification-options-container.show {
    display: block;
    animation: fadeIn 0.3s ease;
}

.notification-options-container h3 {
    color: #2c3e50;
    font-size: 1.1rem;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.notification-options {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.notification-options label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    font-size: 0.95rem;
    color: #555;
}

.notification-frequency {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
    padding-left: 25px;
}

.notification-frequency select,
.notification-frequency input[type="time"] {
    padding: 8px 12px;
    border: 1px solid #dfe6e9;
    border-radius: 6px;
    font-size: 0.9rem;
    background: white;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.mobile-export-buttons {
    display: none;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-top: 20px;
}

.mobile-export-button {
    background: linear-gradient(to right, #3498db, #5dade2);
    border: none;
    border-radius: 8px;
    padding: 12px 5px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    text-align: center;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    min-height: 80px;
}

.mobile-export-button i {
    font-size: 1.8em;
    margin-bottom: 8px;
}

.mobile-export-button.pdf {
    background: linear-gradient(to right, #e74c3c, #ff6b6b);
}

.mobile-export-button.json {
    background: linear-gradient(to right, #f39c12, #f1c40f);
}

.mobile-export-button.import {
    background: linear-gradient(to right, #8e44ad, #9b59b6);
}

.mobile-export-button.whatsapp {
    background: linear-gradient(to right, #128C7E, #128C7E);
}


.mobile-export-button:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.2);
}

.mobile-export-button span {
    font-size: 0.75em;
}

@media (min-width: 769px) {
    .back-to-top {
        position: absolute;
        bottom: 20px;
        right: 20px;
        width: 45px;
        height: 45px;
    }
}

@media (max-width: 768px) {
    body {
        padding: 10px;
    }
    
    .financial-widget {
        padding: 15px;
        padding-bottom: 120px;
    }
    
    .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .tabs {
        flex-direction: column;
    }
    
    .input-section {
        flex-direction: column;
        align-items: stretch;
        padding: 15px;
        gap: 15px;
    }
    
    .input-actions {
        flex-direction: column;
        justify-content: center;
        align-items: stretch;
        gap: 10px;
    }
    
    .btn {
        width: 100%;
        padding: 12px 15px;
        font-size: 0.9em;
    }
    
    .summary-section {
        flex-direction: column;
        gap: 15px;
        padding: 0;
    }
    
    .summary-item {
        width: 100%;
        min-width: 100%;
        padding: 20px;
        margin: 0 0 15px 0;
    }
    
    .summary-item p {
        font-size: 1.4em;
    }
    
    .charts-container {
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }
    
    .chart-container {
        max-width: 100%;
        height: 300px;
        padding: 15px;
    }
    
    .transactions-section {
        padding: 15px;
    }
    
    .transactions-title {
        font-size: 1.0em;
        justify-content: center;
    }
    
    .health-message {
        font-size: 1.0em;
        padding: 12px;
        flex-direction: column;
        text-align: center;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .btn-edit, .btn-delete {
        padding: 8px 10px;
        font-size: 0.85em;
    }
    
    .transactions-table, 
    .transactions-table thead, 
    .transactions-table tbody, 
    .transactions-table th, 
    .transactions-table td, 
    .transactions-table tr {
        display: block;
    }
    
    .transactions-table thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
    }
    
    .transactions-table tr {
        border: 1px solid #e0e6ed;
        margin-bottom: 15px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        position: relative;
    }
    
    .transactions-table td {
        border: none;
        border-bottom: 1px solid #e0e6ed;
        position: relative;
        padding-left: 50%;
        text-align: right;
        font-size: 0.85em;
        padding: 10px 15px;
    }
    
    .transactions-table td:last-child {
        border-bottom: 0;
        text-align: center;
        padding-left: 10px;
    }
    
    .transactions-table td::before {
        content: attr(data-label);
        position: absolute;
        left: 15px;
        width: 45%;
        padding-right: 10px;
        white-space: nowrap;
        text-align: left;
        font-weight: 500;
        color: #2c3e50;
        font-size: 0.85em;
    }
    
    .transactions-table td[data-label="Paga?"][data-is-income="true"]::before {
        display: none;
    }
    
    .action-cell {
        display: flex;
        justify-content: center;
        gap: 10px;
        padding: 10px 0;
    }
    
    .action-cell .btn {
        width: auto;
        padding: 8px 15px;
        font-size: 0.9em;
        display: inline-flex;
    }
    
    .action-cell .btn span {
        display: none;
    }
    
    .type-income, .type-expense {
        font-size: 0.85em;
        padding: 4px 8px;
    }
    
    .category-badge {
        font-size: 0.8em;
    }
    
    .date-cell {
        font-size: 0.8em;
    }
    
    .export-section {
        display: none;
    }
    
    .mobile-export-buttons {
        display: grid;
    }
    
    .date-input {
        padding: 12px;
    }
    
    .recurring-transaction-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }
    
    .recurring-transaction-actions {
        align-self: flex-end;
    }
    
    .recurring-type-selector {
        flex-direction: column;
    }
}

@media (max-width: 480px) {
    h1 {
        font-size: 1.6em;
    }
    
    .date-display {
        font-size: 1.0em;
        padding: 8px 15px;
    }
    
    .input-group input, 
    .input-group select {
        padding: 12px;
    }
    
    .summary-item h3 {
        font-size: 0.9em;
    }
    
    .summary-item p {
        font-size: 1.3em;
    }
    
    .transactions-table td {
        font-size: 0.8em;
        padding: 10px 15px 10px 50%;
    }
    
    .transactions-table td::before {
        font-size: 0.8em;
    }
    
    .action-cell .btn {
        padding: 8px 12px;
        font-size: 0.8em;
    }
    
    .action-cell .btn i {
        font-size: 0.9em;
    }
    
    .back-to-top {
        bottom: 70px;
        right: 15px;
        width: 40px;
        height: 40px;
    }
    
    .mobile-export-button {
        padding: 8px 3px;
        font-size: 0.7em;
    }
    
    .mobile-export-button i {
        font-size: 1.5em;
    }
    
    .notification-settings {
        order: -1;
    }
    
    .notification-options-container {
        right: auto;
        left: 0;
        width: 260px;
    }
}

.active-edit {
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.5);
    transform: scale(1.02);
    transition: all 0.3s ease;
}

#reset-all-data {
    width: 100%;
    background: linear-gradient(to right, #c0392b, #e74c3c);
    margin-bottom: 20px;
}

#reset-all-data:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(231, 76, 60, 0.3);
}

.confirm-reset {
    background: linear-gradient(to right, #e74c3c, #c0392b) !important;
    animation: pulse-danger 0.5s infinite alternate;
}

@keyframes pulse-danger {
    from { transform: scale(1); }
    to { transform: scale(1.05); }
}

.calculator-toggle {
    position: relative;
    display: inline-block;
}

.calculator-icon {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #2c3e50;
    font-size: 1.2rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.calculator-icon:hover {
    background: #e3f2fd;
    transform: scale(1.1);
}

.calculator-container {
    position: fixed;
    left: 50%;
    bottom: 20px;
    transform: translateX(-50%);
    width: 400px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    padding: 15px;
    z-index: 1000;
    display: none;
    animation: fadeIn 0.0s ease;
}

.calculator-container.show {
    display: block;
}

.calculator-display {
    width: 100%;
    height: 50px;
    background: #f8f9fa;
    border-radius: 5px;
    margin-bottom: 10px;
    padding: 10px;
    text-align: right;
    font-size: 1.5em;
    font-weight: bold;
    color: #2c3e50;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.calculator-buttons {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
}

.calc-btn {
    border: none;
    border-radius: 5px;
    padding: 10px;
    font-size: 1.1em;
    cursor: pointer;
    background: #f0f2f5;
    color: #2c3e50;
    transition: all 0.2s;
}

.calc-btn:hover {
    background: #dfe6e9;
}

.calc-btn.operator {
    background: #3498db;
    color: white;
}

.calc-btn.operator:hover {
    background: #2980b9;
}

.calc-btn.equals {
    background: #2ecc71;
    color: white;
}

.calc-btn.equals:hover {
    background: #27ae60;
}

.calc-btn.zero {
    grid-column: span 2;
}

.calc-btn.copy-btn {
    background: linear-gradient(to right, #8e44ad, #9b59b6);
    color: white;
    grid-column: span 3;
}

.calc-btn.copy-btn:hover {
    background: linear-gradient(to right, #9b59b6, #8e44ad);
}

.calc-btn[data-value="⌫"] {
    background: #e74c3c;
    color: white;
    font-weight: bold;
}

/* NOVO: Estilo para badges de status */
.recurring-status {
    font-size: 0.8em;
    padding: 3px 8px;
    border-radius: 12px;
    font-weight: 500;
}

.status-active {
    background: rgba(39, 174, 96, 0.1);
    color: #27ae60;
}

.status-inactive {
    background: rgba(149, 165, 166, 0.1);
    color: #7f8c8d;
}

/* ============================================
   NOVO CSS PARA ANÁLISES AVANÇADAS
============================================= */

.advanced-analytics-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
}

.advanced-analytics-section .section-title {
    color: #2c3e50;
    font-size: 1.2em;
    font-weight: 600;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.advanced-charts-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
    margin-top: 10px;
}

.advanced-chart-container {
    width: 100%;
    max-width: 600px;
    height: 350px;
    background-color: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}

.advanced-chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.advanced-chart-title {
    color: #2c3e50;
    font-size: 1.0em;
    font-weight: 500;
}

.period-selector {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.period-btn {
    padding: 8px 15px;
    border: 2px solid #dfe6e9;
    border-radius: 6px;
    background: white;
    cursor: pointer;
    font-weight: 500;
    color: #7f8c8d;
    transition: all 0.3s ease;
}

.period-btn.active {
    border-color: #3498db;
    color: #3498db;
    background: rgba(52, 152, 219, 0.1);
}

.period-btn:hover:not(.active) {
    background: #f8f9fa;
}

.financial-goals-section {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-top: 20px;
}

.goals-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.btn-add-goal {
    background: linear-gradient(to right, #27ae60, #2ecc71);
    padding: 10px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.btn-add-goal:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
}

.goals-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.goal-item {
    background: white;
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border-left: 4px solid #3498db;
}

.goal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.goal-title {
    font-weight: 600;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 10px;
}

.goal-amount {
    font-weight: 600;
    color: #2c3e50;
}

.goal-progress {
    margin-top: 10px;
}

.progress-bar {
    width: 100%;
    height: 10px;
    background: #f0f2f5;
    border-radius: 5px;
    overflow: hidden;
    margin-bottom: 5px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(to right, #2ecc71, #27ae60);
    border-radius: 5px;
    transition: width 0.3s ease;
}

.goal-details {
    display: flex;
    justify-content: space-between;
    font-size: 0.9em;
    color: #7f8c8d;
}

.goal-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.btn-edit-goal, .btn-delete-goal {
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 0.8em;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-edit-goal {
    background: rgba(52, 152, 219, 0.1);
    color: #3498db;
    border: 1px solid #3498db;
}

.btn-delete-goal {
    background: rgba(231, 76, 60, 0.1);
    color: #e74c3c;
    border: 1px solid #e74c3c;
}

.goal-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2002;
    display: none;
}

.goal-modal {
    background: white;
    border-radius: 12px;
    padding: 25px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.goal-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.goal-modal-header h2 {
    color: #2c3e50;
    font-size: 1.5em;
    display: flex;
    align-items: center;
    gap: 10px;
}

.close-goal-modal {
    background: none;
    border: none;
    font-size: 1.5em;
    cursor: pointer;
    color: #7f8c8d;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.metric-card {
    background: white;
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    box-shadow: 0 3px 10px rgba(0,0,0,0.08);
}

.metric-value {
    font-size: 1.5em;
    font-weight: 700;
    margin: 5px 0;
}

.metric-positive {
    color: #27ae60;
}

.metric-negative {
    color: #e74c3c;
}

.metric-neutral {
    color: #3498db;
}

.empty-state {
    text-align: center;
    padding: 30px;
    color: #95a5a6;
    font-style: italic;
}

.empty-state i {
    font-size: 2em;
    margin-bottom: 10px;
    display: block;
}

@media (max-width: 768px) {
    .advanced-chart-container {
        max-width: 100%;
        height: 300px;
        padding: 15px;
    }
    
    .period-selector {
        justify-content: center;
    }
    
    .goals-header {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
    }
    
    .btn-add-goal {
        width: 100%;
        justify-content: center;
    }
    
    .metrics-grid {
        grid-template-columns: 1fr;
    }
}
</style>
</head>
<body>
    <div class="export-notification" id="export-notification">
        <i class="fas fa-check-circle"></i> <span id="notification-text"></span>
    </div>
    
    <div class="import-overlay" id="import-overlay">
        <div class="import-modal">
            <div class="modal-header">
                <h2><i class="fas fa-file-import"></i> Importar Dados Financeiros</h2>
                <button class="close-modal" id="close-import-modal">&times;</button>
            </div>
            <div class="modal-content">
                <p>Selecione um arquivo JSON exportado anteriormente para importar seus dados financeiros.</p>
                
                <div class="file-input-wrapper">
                    <label class="file-label" for="import-file-input">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <div>Clique para selecionar um arquivo</div>
                        <div class="file-name" id="file-name-display">Nenhum arquivo selecionado</div>
                    </label>
                    <input type="file" id="import-file-input" class="file-input" accept=".json">
                </div>
                
                <div class="import-options">
                    <p><strong>Opções de importação:</strong></p>
                    <div style="margin: 10px 0;">
                        <input type="radio" id="merge-data" name="import-option" value="merge" checked>
                        <label for="merge-data">Mesclar com dados existentes</label>
                    </div>
                    <div>
                        <input type="radio" id="replace-data" name="import-option" value="replace">
                        <label for="replace-data">Substituir todos os dados existentes</label>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel" id="cancel-import">Cancelar</button>
                <button class="btn btn-update" id="confirm-import" disabled>Importar Dados</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para transações recorrentes -->
    <div class="recurring-modal-overlay" id="recurring-modal-overlay">
        <div class="recurring-modal">
            <div class="recurring-modal-header">
                <h2><i class="fas fa-calendar-alt"></i> <span id="recurring-modal-title">Nova Transação Recorrente</span></h2>
                <button class="close-recurring-modal" id="close-recurring-modal">&times;</button>
            </div>
            <div class="recurring-modal-content">
                <div class="recurring-type-selector">
                    <button class="recurring-type-btn income" data-type="income">
                        <i class="fas fa-arrow-up"></i> Renda
                    </button>
                    <button class="recurring-type-btn expense" data-type="expense">
                        <i class="fas fa-arrow-down"></i> Despesa
                    </button>
                </div>
                
                <div class="input-group">
                    <label for="recurring-description"><i class="fas fa-pen"></i> Descrição:</label>
                    <input type="text" id="recurring-description" placeholder="Ex: Salário, Aluguel" required>
                </div>
                
                <div class="input-group">
                    <label for="recurring-value"><i class="fas fa-money-bill-wave"></i> Valor (R$):</label>
                    <input type="number" id="recurring-value" placeholder="Ex: 1500.00" step="0.01" required>
                </div>
                
                <div class="input-group">
                    <label for="recurring-category"><i class="fas fa-tag"></i> Categoria:</label>
                    <select id="recurring-category" required>
                        <option value="" disabled selected>Selecione uma categoria</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="recurring-day"><i class="fas fa-calendar-day"></i> Dia do mês:</label>
                    <input type="number" id="recurring-day" min="1" max="31" placeholder="1-31" required>
                </div>
                
                <div class="input-group">
                    <label for="recurring-active"><i class="fas fa-toggle-on"></i> Status:</label>
                    <select id="recurring-active">
                        <option value="true" selected>Ativo</option>
                        <option value="false">Inativo</option>
                    </select>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel" id="cancel-recurring-modal">Cancelar</button>
                <button class="btn btn-update" id="save-recurring-transaction">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para Adicionar/Editar Meta -->
    <div class="goal-modal-overlay" id="goal-modal-overlay">
        <div class="goal-modal">
            <div class="goal-modal-header">
                <h2><i class="fas fa-bullseye"></i> <span id="goal-modal-title">Nova Meta Financeira</span></h2>
                <button class="close-goal-modal" id="close-goal-modal">&times;</button>
            </div>
            <div class="goal-modal-content">
                <div class="input-group">
                    <label for="goal-title"><i class="fas fa-pen"></i> Título da Meta:</label>
                    <input type="text" id="goal-title" placeholder="Ex: Economia para viagem" required>
                </div>
                
                <div class="input-group">
                    <label for="goal-target"><i class="fas fa-money-bill-wave"></i> Valor Alvo (R$):</label>
                    <input type="number" id="goal-target" placeholder="Ex: 5000.00" step="0.01" required>
                </div>
                
                <div class="input-group">
                    <label for="goal-current"><i class="fas fa-wallet"></i> Valor Atual (R$):</label>
                    <input type="number" id="goal-current" placeholder="Ex: 1500.00" step="0.01" required>
                </div>
                
                <div class="input-group">
                    <label for="goal-deadline"><i class="fas fa-calendar-day"></i> Data Limite:</label>
                    <input type="date" id="goal-deadline" required>
                </div>
                
                <div class="input-group">
                    <label for="goal-category"><i class="fas fa-tag"></i> Categoria:</label>
                    <select id="goal-category">
                        <option value="economia">Economia</option>
                        <option value="investimento">Investimento</option>
                        <option value="divida">Quitar Dívida</option>
                        <option value="compra">Compra Específica</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel" id="cancel-goal-modal">Cancelar</button>
                <button class="btn btn-update" id="save-goal">Salvar Meta</button>
            </div>
        </div>
    </div>
    
    <div class="financial-widget" id="financial-widget-content">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> GG - Controle Financeiro</h1>
            <div class="header-right">
                <div class="notification-settings">
                    <div class="notification-icon" id="notification-toggle">
                    </div>
                    <div class="notification-options-container" id="notification-options">
                        <h3><i class="fas fa-bell"></i> Lembretes</h3>
                        <div class="notification-options">
                            <label>
                                <input type="checkbox" id="enable-notifications"> Ativar lembretes
                            </label>
                            <div class="notification-frequency" id="notification-frequency">
                                <label>Frequência:</label>
                                <select id="reminder-frequency">
                                    <option value="daily">Diariamente</option>
                                    <option value="weekly">Semanalmente</option>
                                    <option value="biweekly">Quinzenalmente</option>
                                    <option value="monthly">Mensalmente</option>
                                </select>
                                <input type="time" id="reminder-time" value="18:00">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="calculator-toggle" id="calculator-toggle">
                    <div class="calculator-icon">
                        <i class="fas fa-calculator"></i>
                    </div>
                    <div class="calculator-container" id="calculator-container">
                        <div class="calculator-display" id="calculator-display">0</div>
                        
                        <div class="calculator-buttons">
                            <button class="calc-btn" data-value="C">C</button>
                            <button class="calc-btn" data-value="±">±</button>
                            <button class="calc-btn" data-value="%">%</button>
                            <button class="calc-btn operator" data-value="/">÷</button>
                            <button class="calc-btn" data-value="7">7</button>
                            <button class="calc-btn" data-value="8">8</button>
                            <button class="calc-btn" data-value="9">9</button>
                            <button class="calc-btn operator" data-value="*">×</button>
                            <button class="calc-btn" data-value="4">4</button>
                            <button class="calc-btn" data-value="5">5</button>
                            <button class="calc-btn" data-value="6">6</button>
                            <button class="calc-btn operator" data-value="-">-</button>
                            <button class="calc-btn" data-value="1">1</button>
                            <button class="calc-btn" data-value="2">2</button>
                            <button class="calc-btn" data-value="3">3</button>
                            <button class="calc-btn operator" data-value="+">+</button>
                            <button class="calc-btn zero" data-value="0">0</button>
                            <button class="calc-btn" data-value=".">.</button>
                            <button class="calc-btn equals" data-value="=">=</button>
                            <button class="calc-btn copy-btn" data-action="copy"><i class="fas fa-copy"></i> Copiar</button>
                            <button class="calc-btn" data-value="⌫"><i class="fas fa-backspace"></i></button>
                        </div>
                    </div>
                </div>
                
                <div class="date-display">
                    <i class="fas fa-calendar-alt"></i> <span id="current-date"></span>
                </div>
            </div>
        </div>

        <!-- Abas de navegação -->
        <div class="tabs">
            <div class="tab active" data-tab="transactions">
                <i class="fas fa-exchange-alt"></i>
                <span>Transações</span>
            </div>
            <div class="tab" data-tab="reports">
                <i class="fas fa-chart-bar"></i>
                <span>Relatórios</span>
            </div>
            <div class="tab" data-tab="settings">
                <i class="fas fa-cog"></i>
                <span>Configurações</span>
            </div>
        </div>

        <!-- Conteúdo da aba Transações -->
        <div class="tab-content active" id="transactions-tab">
            <div class="input-section">
                <div class="input-group">
                    <label for="description"><i class="fas fa-pen"></i> Descrição:</label>
                    <input type="text" id="description" placeholder="Ex: Salário, Aluguel" required>
                </div>
                <div class="input-group">
                    <label for="value"><i class="fas fa-money-bill-wave"></i> Valor (R$):</label>
                    <input type="number" id="value" placeholder="Ex: 1500.00" step="0.01" required>
                </div>
                <div class="input-group">
                    <label for="category"><i class="fas fa-tag"></i> Categoria:</label>
                    <select id="category" required>
                        <option value="" disabled selected>Selecione uma categoria</option>
                    </select>
                    <div class="error-message" id="category-error">Selecione uma categoria válida para este tipo de transação</div>
                </div>
                <div class="input-group">
                    <label for="transaction-date"><i class="fas fa-calendar-day"></i> Data:</label>
                    <div class="date-input-container">
                        <input type="date" id="transaction-date" class="date-input">
                    </div>
                </div>
                <div class="input-actions">
                    <button id="add-income" class="btn btn-income">
                        <i class="fas fa-plus-circle"></i> Adicionar Renda
                    </button>
                    <button id="add-expense" class="btn btn-expense">
                        <i class="fas fa-minus-circle"></i> Adicionar Despesa
                    </button>
                </div>
                
                <div id="edit-mode-section" class="action-buttons" style="display: none;">
                    <button id="update-transaction" class="btn btn-update">
                        <i class="fas fa-save"></i> Atualizar Transação
                    </button>
                    <button id="cancel-edit" class="btn btn-cancel">
                        <i class="fas fa-times"></i> Cancelar Edição
                    </button>
                </div>
            </div>

            <div class="summary-section">
                <div class="summary-item">
                    <h3><i class="fas fa-arrow-up"></i> Renda Total:</h3>
                    <p id="total-income">R$ 0.00</p>
                </div>
                <div class="summary-item">
                    <h3><i class="fas fa-arrow-down"></i> Despesa Total:</h3>
                    <p id="total-expense">R$ 0.00</p>
                </div>
                <div class="summary-item">
                    <h3><i class="fas fa-balance-scale"></i> Saldo Final:</h3>
                    <p id="current-balance">R$ 0.00</p>
                </div>
                <div class="summary-item">
                    <h3><i class="fas fa-wallet"></i> Saldo Atual:</h3>
                    <p id="real-balance">R$ 0.00</p>
                </div>
                <div class="summary-item">
                    <h3><i class="fas fa-check-circle"></i> Total Pago:</h3>
                    <p id="total-paid">R$ 0.00</p>
                </div>
                <div class="summary-item">
                    <h3><i class="fas fa-clock"></i> Total Pendente:</h3>
                    <p id="total-pending">R$ 0.00</p>
                </div>
            </div>

            <div class="transactions-section">
                <div class="transactions-header">
                    <div class="transactions-title">
                        <i class="fas fa-list"></i> Detalhes das Transações
                        <span class="transactions-count" id="transactions-indicator">0</span>
                    </div>
                </div>
                
                <table class="transactions-table" id="transactions-table">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Data</th>
                            <th>Descrição</th>
                            <th>Categoria</th>
                            <th>Valor</th>
                            <th>Paga?</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Conteúdo da aba Configurações -->
        <div class="tab-content" id="settings-tab">
            <div class="settings-section">
                <div class="settings-header">
                    <div class="settings-title">
                        <i class="fas fa-cog"></i> Configurações do Sistema
                    </div>
                </div>
                
                <div class="settings-description">
                    <p>Configure suas transações recorrentes que se repetem mês após mês, como salário e aluguel.</p>
                </div>
                
                <div class="recurring-transactions">
                    <div class="recurring-transactions-header">
                        <h3><i class="fas fa-redo"></i> Transações Recorrentes</h3>
                        <button class="btn btn-add-recurring" id="add-recurring-transaction">
                            <i class="fas fa-plus"></i> Nova Recorrente
                        </button>
                    </div>
                    
                    <div class="recurring-transactions-list" id="recurring-transactions-list">
                        <!-- Lista de transações recorrentes será gerada aqui -->
                    </div>
                    
                    <button class="btn btn-apply-recurring" id="apply-recurring-transactions">
                        <i class="fas fa-check-circle"></i> Aplicar Transações Recorrentes do Mês
                    </button>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-header">
                    <div class="settings-title">
                        <i class="fas fa-bell"></i> Configurações de Notificações
                    </div>
                </div>
                
                <div class="notification-options" style="padding: 15px; background: white; border-radius: 8px;">
                    <label>
                        <input type="checkbox" id="enable-notifications-settings"> Ativar lembretes
                    </label>
                    <div class="notification-frequency" id="notification-frequency-settings">
                        <label>Frequência:</label>
                        <select id="reminder-frequency-settings">
                            <option value="daily">Diariamente</option>
                            <option value="weekly">Semanalmente</option>
                            <option value="biweekly">Quinzenalmente</option>
                            <option value="monthly">Mensalmente</option>
                        </select>
                        <input type="time" id="reminder-time-settings" value="18:00">
                    </div>
                </div>
            </div>
                    <button id="reset-all-data" class="btn btn-delete" style="margin-top: 20px;">
                    <i class="fas fa-trash-alt"></i> Limpar Todos os Dados
                    </button>
        </div>

        <!-- Conteúdo da aba Relatórios -->
        <div class="tab-content" id="reports-tab">
            <div class="charts-section">
                <div class="section-title"><i class="fas fa-chart-pie"></i> Gráficos de Finanças</div>
                <div class="charts-container">
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">Distribuição de Despesas</div>
                        </div>
                        <canvas id="expense-chart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">Análise Percentual</div>
                        </div>
                        <canvas id="summary-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="financial-health-section">
                <div class="section-title"><i class="fas fa-heartbeat"></i> Saúde Financeira</div>
                <div class="health-message" id="financial-health-message">
                    <i class="fas fa-info-circle"></i>
                    <span>Adicione transações para analisar sua saúde financeira</span>
                </div>
            </div>

            <!-- NOVA SEÇÃO: Análises Avançadas -->
            <div class="advanced-analytics-section">
                <div class="section-title"><i class="fas fa-chart-line"></i> Análises Avançadas</div>
                
                <!-- Seletor de Período -->
                <div class="period-selector">
                    <span>Período:</span>
                    <button class="period-btn active" data-period="monthly">Mensal</button>
                    <button class="period-btn" data-period="quarterly">Trimestral</button>
                    <button class="period-btn" data-period="yearly">Anual</button>
                    <button class="period-btn" data-period="all">Todo Período</button>
                </div>
                
                <!-- Gráficos Temporais -->
                <div class="advanced-charts-container">
                    <div class="advanced-chart-container">
                        <div class="advanced-chart-header">
                            <div class="advanced-chart-title">Evolução do Saldo ao Longo do Tempo</div>
                        </div>
                        <canvas id="balance-history-chart"></canvas>
                    </div>
                    
                    <div class="advanced-chart-container">
                        <div class="advanced-chart-header">
                            <div class="advanced-chart-title">Comparativo Mensal</div>
                        </div>
                        <canvas id="monthly-comparison-chart"></canvas>
                    </div>
                </div>
                
                <!-- Métricas Financeiras -->
                <div class="metrics-grid">
                    <div class="metric-card">
                        <h3><i class="fas fa-trend-up"></i> Maior Saldo</h3>
                        <p class="metric-value metric-positive" id="highest-balance">R$ 0.00</p>
                        <p class="metric-date" id="highest-balance-date">--/--/----</p>
                    </div>
                    <div class="metric-card">
                        <h3><i class="fas fa-trend-down"></i> Menor Saldo</h3>
                        <p class="metric-value metric-negative" id="lowest-balance">R$ 0.00</p>
                        <p class="metric-date" id="lowest-balance-date">--/--/----</p>
                    </div>
                    <div class="metric-card">
                        <h3><i class="fas fa-calculator"></i> Média Mensal</h3>
                        <p class="metric-value metric-neutral" id="monthly-average">R$ 0.00</p>
                        <p class="metric-period">Últimos 6 meses</p>
                    </div>
                    <div class="metric-card">
                        <h3><i class="fas fa-bullseye"></i> Meta de Economia</h3>
                        <p class="metric-value metric-positive" id="saving-rate">0%</p>
                        <p class="metric-target">(Meta: 20%)</p>
                    </div>
                </div>
                
                <!-- Metas Financeiras -->
                <div class="financial-goals-section">
                    <div class="goals-header">
                        <div class="section-title"><i class="fas fa-bullseye"></i> Metas Financeiras</div>
                        <button class="btn-add-goal" id="add-goal-btn">
                            <i class="fas fa-plus"></i> Nova Meta
                        </button>
                    </div>
                    
                    <div class="goals-list" id="goals-list">
                        <div class="empty-state">
                            <i class="fas fa-bullseye"></i>
                            <p>Nenhuma meta financeira definida</p>
                            <p>Clique em "Nova Meta" para começar</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="export-section">
                <button id="export-pdf" class="btn btn-pdf">
                    <i class="fas fa-file-pdf"></i> Exportar PDF
                </button>
                <button id="export-json" class="btn btn-json">
                    <i class="fas fa-file-export"></i> Exportar (JSON)
                </button>
                <button id="import-data" class="btn btn-import">
                    <i class="fas fa-file-import"></i> Importar (JSON)
                </button>
                <button id="share-whatsapp" class="btn btn-whatsapp">
                    <i class="fab fa-whatsapp"></i> WhatsApp
                </button>
            </div>
            
            <div class="mobile-export-buttons">
                <button class="mobile-export-button pdf" id="mobile-pdf">
                    <i class="fas fa-file-pdf"></i>
                    <span>Gerar Relatório</span>
                </button>
                <button class="mobile-export-button json" id="mobile-json">
                    <i class="fas fa-file-export"></i>
                    <span>Exportar</span>
                </button>
                <button class="mobile-export-button import" id="mobile-import">
                    <i class="fas fa-file-import"></i>
                    <span>Importar</span>
                </button>
                <button class="mobile-export-button whatsapp" id="mobile-whatsapp">
                    <i class="fab fa-whatsapp"></i>
                    <span>WhatsApp</span>
                </button>
                </button>
            </div>
        </div>
        
        <div class="back-to-top" id="back-to-top">
            <i class="fas fa-arrow-up"></i>
        </div>
        
        <div class="widget-footer">
            Guilherme Silva Vanderley © 2025 - Atualizado em: 23/12/25
        </div>
    </div>

<script>
// ============================================
// VARIÁVEIS GLOBAIS E REFERÊNCIAS DO DOM
// ============================================

// Elementos principais
const descriptionInput = document.getElementById('description');
const valueInput = document.getElementById('value');
const categoryInput = document.getElementById('category');
const transactionDateInput = document.getElementById('transaction-date');
const addIncomeBtn = document.getElementById('add-income');
const addExpenseBtn = document.getElementById('add-expense');
const totalIncomeElem = document.getElementById('total-income');
const totalExpenseElem = document.getElementById('total-expense');
const currentBalanceElem = document.getElementById('current-balance');
const totalPaidElem = document.getElementById('total-paid');
const totalPendingElem = document.getElementById('total-pending');
const realBalanceElem = document.getElementById('real-balance');
const transactionsTableBody = document.querySelector('#transactions-table tbody');
const exportPdfBtn = document.getElementById('export-pdf');
const exportJsonBtn = document.getElementById('export-json');
const importDataBtn = document.getElementById('import-data');
const expenseChartCanvas = document.getElementById('expense-chart').getContext('2d');
const summaryChartCanvas = document.getElementById('summary-chart').getContext('2d');
const currentDateElem = document.getElementById('current-date');
const updateBtn = document.getElementById('update-transaction');
const cancelBtn = document.getElementById('cancel-edit');
const editModeSection = document.getElementById('edit-mode-section');
const categoryError = document.getElementById('category-error');
const exportNotification = document.getElementById('export-notification');
const notificationText = document.getElementById('notification-text');
const importOverlay = document.getElementById('import-overlay');
const closeImportModal = document.getElementById('close-import-modal');
const cancelImportBtn = document.getElementById('cancel-import');
const confirmImportBtn = document.getElementById('confirm-import');
const importFileInput = document.getElementById('import-file-input');
const fileNameDisplay = document.getElementById('file-name-display');
const financialHealthMessage = document.getElementById('financial-health-message');
const transactionsIndicator = document.getElementById('transactions-indicator');
const backToTopBtn = document.getElementById('back-to-top');
const shareWhatsappBtn = document.getElementById('share-whatsapp');

// Elementos das abas
const tabs = document.querySelectorAll('.tab');
const tabContents = document.querySelectorAll('.tab-content');

// Elementos da aba Configurações
const addRecurringBtn = document.getElementById('add-recurring-transaction');
const applyRecurringBtn = document.getElementById('apply-recurring-transactions');
const recurringTransactionsList = document.getElementById('recurring-transactions-list');

// Elementos do modal de transações recorrentes
const recurringModalOverlay = document.getElementById('recurring-modal-overlay');
const closeRecurringModal = document.getElementById('close-recurring-modal');
const cancelRecurringModal = document.getElementById('cancel-recurring-modal');
const saveRecurringBtn = document.getElementById('save-recurring-transaction');
const recurringModalTitle = document.getElementById('recurring-modal-title');
const recurringDescriptionInput = document.getElementById('recurring-description');
const recurringValueInput = document.getElementById('recurring-value');
const recurringCategoryInput = document.getElementById('recurring-category');
const recurringDayInput = document.getElementById('recurring-day');
const recurringActiveInput = document.getElementById('recurring-active');
const recurringTypeButtons = document.querySelectorAll('.recurring-type-btn');

// Botões mobile
const mobilePdfBtn = document.getElementById('mobile-pdf');
const mobileJsonBtn = document.getElementById('mobile-json');
const mobileImportBtn = document.getElementById('mobile-import');
const mobileWhatsappBtn = document.getElementById('mobile-whatsapp');

// Notificações
const enableNotificationsCheckbox = document.getElementById('enable-notifications');
const reminderFrequencySelect = document.getElementById('reminder-frequency');
const reminderTimeInput = document.getElementById('reminder-time');
const notificationFrequencyDiv = document.getElementById('notification-frequency');

// ============================================
// VARIÁVEIS PARA ANÁLISES AVANÇADAS
// ============================================

// Elementos das análises avançadas
const periodButtons = document.querySelectorAll('.period-btn');
const balanceHistoryChartCanvas = document.getElementById('balance-history-chart').getContext('2d');
const monthlyComparisonChartCanvas = document.getElementById('monthly-comparison-chart').getContext('2d');
const highestBalanceElem = document.getElementById('highest-balance');
const lowestBalanceElem = document.getElementById('lowest-balance');
const monthlyAverageElem = document.getElementById('monthly-average');
const savingRateElem = document.getElementById('saving-rate');
const highestBalanceDateElem = document.getElementById('highest-balance-date');
const lowestBalanceDateElem = document.getElementById('lowest-balance-date');

// Elementos de metas financeiras
const addGoalBtn = document.getElementById('add-goal-btn');
const goalsList = document.getElementById('goals-list');
const goalModalOverlay = document.getElementById('goal-modal-overlay');
const closeGoalModal = document.getElementById('close-goal-modal');
const cancelGoalModal = document.getElementById('cancel-goal-modal');
const saveGoalBtn = document.getElementById('save-goal');
const goalModalTitle = document.getElementById('goal-modal-title');
const goalTitleInput = document.getElementById('goal-title');
const goalTargetInput = document.getElementById('goal-target');
const goalCurrentInput = document.getElementById('goal-current');
const goalDeadlineInput = document.getElementById('goal-deadline');
const goalCategoryInput = document.getElementById('goal-category');

// ============================================
// VARIÁVEIS DE ESTADO
// ============================================

// Transações regulares
let transactions = [];
let expenseChart;
let summaryChart;
let isEditMode = false;
let currentEditId = null;
let currentTransactionType = null;
let importOption = "merge";

// Transações recorrentes
let recurringTransactions = [];

// Notificações
let notificationEnabled = false;
let notificationFrequency = 'daily';
let notificationTime = '18:00';
let notificationInterval = null;

// Modal de transações recorrentes
let recurringEditMode = false;
let currentRecurringEditId = null;
let currentRecurringType = 'income';

// Análises avançadas
let balanceHistoryChart = null;
let monthlyComparisonChart = null;
let financialGoals = [];
let currentPeriod = 'monthly';
let goalEditMode = false;
let currentGoalEditId = null;

// Categorias pré-definidas
const incomeCategories = ["Salário", "Freelance", "Investimentos", "Presente", "13° Salário", "1/3 de Férias", "Outros"];
const expenseCategories = ["Moradia", "Mercado", "Transporte", "Lazer", "Saúde", "Educação", "Ifood", "Cartão de Crédito", "Não identificado", "Outros"];

// ============================================
// FUNÇÕES DE INICIALIZAÇÃO
// ============================================

// Inicializar data atual
function initializeDate() {
    const now = new Date();
    currentDateElem.textContent = now.toLocaleDateString('pt-BR', { 
        day: 'numeric', 
        month: 'long', 
        year: 'numeric' 
    });
    transactionDateInput.valueAsDate = now;
}

// ============================================
// FUNÇÕES DAS ABAS
// ============================================

function setupTabs() {
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const tabId = tab.getAttribute('data-tab');
            
            // Atualizar aba ativa
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            // Atualizar conteúdo ativo
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabId}-tab`).classList.add('active');
            
            // Scroll para o topo
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    });
}

// ============================================
// FUNÇÕES DE TRANSAÇÕES RECORRENTES (NOVAS)
// ============================================

// Carregar transações recorrentes do localStorage
function loadRecurringTransactions() {
    const stored = localStorage.getItem('recurringTransactions');
    if (stored) {
        recurringTransactions = JSON.parse(stored);
    }
    renderRecurringTransactions();
}

// Salvar transações recorrentes no localStorage
function saveRecurringTransactions() {
    localStorage.setItem('recurringTransactions', JSON.stringify(recurringTransactions));
}

// Adicionar nova transação recorrente
function addRecurringTransaction(type, description, value, category, day, active) {
    const transaction = {
        id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
        type,
        description,
        value: parseFloat(value),
        category,
        day: parseInt(day),
        active: active === 'true',
        createdAt: new Date().toISOString()
    };
    
    recurringTransactions.push(transaction);
    saveRecurringTransactions();
    renderRecurringTransactions();
    
    return transaction;
}

// Atualizar transação recorrente existente
function updateRecurringTransaction(id, updates) {
    const index = recurringTransactions.findIndex(t => t.id === id);
    if (index !== -1) {
        recurringTransactions[index] = {
            ...recurringTransactions[index],
            ...updates,
            updatedAt: new Date().toISOString()
        };
        saveRecurringTransactions();
        renderRecurringTransactions();
        return true;
    }
    return false;
}

// Remover transação recorrente
function deleteRecurringTransaction(id) {
    if (confirm('Tem certeza que deseja excluir esta transação recorrente?')) {
        recurringTransactions = recurringTransactions.filter(t => t.id !== id);
        saveRecurringTransactions();
        renderRecurringTransactions();
        
        notificationText.textContent = "Transação recorrente excluída!";
        showExportNotification();
    }
}

// Renderizar lista de transações recorrentes
function renderRecurringTransactions() {
    recurringTransactionsList.innerHTML = '';
    
    if (recurringTransactions.length === 0) {
        recurringTransactionsList.innerHTML = `
            <div class="recurring-transaction-empty">
                <i class="fas fa-calendar-plus fa-2x"></i>
                <p>Nenhuma transação recorrente configurada</p>
                <p>Clique em "Nova Recorrente" para adicionar</p>
            </div>
        `;
        return;
    }
    
    // Ordenar por tipo e dia
    const sortedTransactions = [...recurringTransactions].sort((a, b) => {
        if (a.type !== b.type) return a.type === 'income' ? -1 : 1;
        return a.day - b.day;
    });
    
    sortedTransactions.forEach(transaction => {
        const item = document.createElement('div');
        item.className = `recurring-transaction-item ${transaction.type}`;
        
        const statusClass = transaction.active ? 'status-active' : 'status-inactive';
        const statusText = transaction.active ? 'Ativo' : 'Inativo';
        const typeIcon = transaction.type === 'income' ? 'fa-arrow-up' : 'fa-arrow-down';
        const typeColor = transaction.type === 'income' ? '#27ae60' : '#e74c3c';
        
        item.innerHTML = `
            <div class="recurring-transaction-info">
                <div class="recurring-transaction-name">
                    <i class="fas ${typeIcon}" style="color: ${typeColor};"></i>
                    ${transaction.description}
                    <span class="recurring-status ${statusClass}">${statusText}</span>
                </div>
                <div class="recurring-transaction-details">
                    <span><i class="fas fa-tag"></i> ${transaction.category}</span>
                    <span><i class="fas fa-calendar-day"></i> Dia ${transaction.day}</span>
                    <span class="recurring-transaction-value">${formatCurrency(transaction.value)}</span>
                </div>
            </div>
            <div class="recurring-transaction-actions">
                <button class="btn btn-edit edit-recurring" data-id="${transaction.id}">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-delete delete-recurring" data-id="${transaction.id}">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        `;
        
        recurringTransactionsList.appendChild(item);
    });
    
    // Adicionar event listeners aos botões
    document.querySelectorAll('.edit-recurring').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = e.currentTarget.getAttribute('data-id');
            editRecurringTransaction(id);
        });
    });
    
    document.querySelectorAll('.delete-recurring').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = e.currentTarget.getAttribute('data-id');
            deleteRecurringTransaction(id);
        });
    });
}

// Abrir modal para editar transação recorrente
function editRecurringTransaction(id) {
    const transaction = recurringTransactions.find(t => t.id === id);
    if (!transaction) return;
    
    recurringEditMode = true;
    currentRecurringEditId = id;
    currentRecurringType = transaction.type;
    
    recurringModalTitle.textContent = 'Editar Transação Recorrente';
    recurringDescriptionInput.value = transaction.description;
    recurringValueInput.value = transaction.value;
    recurringDayInput.value = transaction.day;
    recurringActiveInput.value = transaction.active.toString();
    
    // Definir tipo
    recurringTypeButtons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-type') === transaction.type) {
            btn.classList.add('active');
        }
    });
    
    // Preencher categorias
    populateRecurringCategories(transaction.type);
    setTimeout(() => {
        recurringCategoryInput.value = transaction.category;
    }, 10);
    
    // Mostrar modal
    recurringModalOverlay.style.display = 'flex';
}

// Aplicar transações recorrentes do mês atual
function applyRecurringTransactions() {
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    
    // Verificar transações recorrentes ativas
    const activeRecurring = recurringTransactions.filter(t => t.active);
    
    if (activeRecurring.length === 0) {
        alert('Nenhuma transação recorrente ativa encontrada.');
        return;
    }
    
    let addedCount = 0;
    let skippedCount = 0;
    
    activeRecurring.forEach(transaction => {
        // Verificar se já existe uma transação igual este mês
        const existingTransaction = transactions.find(t => {
            const tDate = new Date(t.date);
            return (
                t.description === transaction.description &&
                Math.abs(t.value) === Math.abs(transaction.value) &&
                t.type === transaction.type &&
                tDate.getMonth() === currentMonth &&
                tDate.getFullYear() === currentYear
            );
        });
        
        if (!existingTransaction) {
            // Criar data para este mês
            const transactionDate = new Date(currentYear, currentMonth, transaction.day);
            
            // Se o dia for maior que os dias do mês, ajustar para o último dia
            const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const day = Math.min(transaction.day, lastDayOfMonth);
            transactionDate.setDate(day);
            
            // Adicionar transação
            const newTransaction = {
                id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                description: transaction.description,
                category: transaction.category,
                value: transaction.type === 'expense' ? -transaction.value : transaction.value,
                type: transaction.type,
                date: transactionDate.toISOString().split('T')[0],
                ...(transaction.type === 'expense' && { paga: false })
            };
            
            transactions.push(newTransaction);
            addedCount++;
        } else {
            skippedCount++;
        }
    });
    
    if (addedCount > 0) {
        saveTransactions();
        updateUI();
        
        notificationText.textContent = `${addedCount} transações recorrentes adicionadas! ${skippedCount} já existiam.`;
        showExportNotification();
    } else {
        alert('Todas as transações recorrentes já foram aplicadas este mês.');
    }
}

// Preencher categorias no modal de recorrentes
function populateRecurringCategories(type) {
    recurringCategoryInput.innerHTML = '<option value="" disabled selected>Selecione uma categoria</option>';
    
    const categories = type === 'income' ? incomeCategories : expenseCategories;
    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        recurringCategoryInput.appendChild(option);
    });
}

// Configurar modal de transações recorrentes
function setupRecurringModal() {
    // Botões de tipo
    recurringTypeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const type = btn.getAttribute('data-type');
            currentRecurringType = type;
            
            recurringTypeButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            populateRecurringCategories(type);
        });
    });
    
    // Fechar modal
    closeRecurringModal.addEventListener('click', () => {
        recurringModalOverlay.style.display = 'none';
        resetRecurringModal();
    });
    
    cancelRecurringModal.addEventListener('click', () => {
        recurringModalOverlay.style.display = 'none';
        resetRecurringModal();
    });
    
    // Salvar transação
    saveRecurringBtn.addEventListener('click', () => {
        const description = recurringDescriptionInput.value.trim();
        const value = recurringValueInput.value;
        const category = recurringCategoryInput.value;
        const day = recurringDayInput.value;
        const active = recurringActiveInput.value;
        
        if (!description || !value || !category || !day) {
            alert('Por favor, preencha todos os campos.');
            return;
        }
        
        if (day < 1 || day > 31) {
            alert('O dia do mês deve estar entre 1 e 31.');
            return;
        }
        
        if (recurringEditMode) {
            updateRecurringTransaction(currentRecurringEditId, {
                type: currentRecurringType,
                description,
                value: parseFloat(value),
                category,
                day: parseInt(day),
                active: active === 'true'
            });
            
            notificationText.textContent = "Transação recorrente atualizada!";
        } else {
            addRecurringTransaction(currentRecurringType, description, value, category, day, active);
            
            notificationText.textContent = "Transação recorrente adicionada!";
        }
        
        showExportNotification();
        recurringModalOverlay.style.display = 'none';
        resetRecurringModal();
    });
    
    // Abrir modal para nova transação
    addRecurringBtn.addEventListener('click', () => {
        recurringEditMode = false;
        currentRecurringEditId = null;
        recurringModalTitle.textContent = 'Nova Transação Recorrente';
        resetRecurringModal();
        
        // Definir tipo padrão
        recurringTypeButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-type') === 'income') {
                btn.classList.add('active');
            }
        });
        
        currentRecurringType = 'income';
        populateRecurringCategories('income');
        
        // Mostrar modal
        recurringModalOverlay.style.display = 'flex';
    });
    
    // Aplicar transações recorrentes
    applyRecurringBtn.addEventListener('click', applyRecurringTransactions);
}

// Resetar modal de transações recorrentes
function resetRecurringModal() {
    recurringDescriptionInput.value = '';
    recurringValueInput.value = '';
    recurringCategoryInput.innerHTML = '<option value="" disabled selected>Selecione uma categoria</option>';
    recurringDayInput.value = '';
    recurringActiveInput.value = 'true';
    recurringEditMode = false;
    currentRecurringEditId = null;
}

// ============================================
// FUNÇÕES DE ANÁLISES AVANÇADAS
// ============================================

// Carregar metas financeiras
function loadFinancialGoals() {
    const stored = localStorage.getItem('financialGoals');
    if (stored) {
        financialGoals = JSON.parse(stored);
    }
    renderFinancialGoals();
    updateAdvancedAnalytics();
}

// Salvar metas financeiras
function saveFinancialGoals() {
    localStorage.setItem('financialGoals', JSON.stringify(financialGoals));
}

// Adicionar nova meta
function addFinancialGoal(title, target, current, deadline, category) {
    const goal = {
        id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
        title,
        target: parseFloat(target),
        current: parseFloat(current),
        deadline,
        category,
        createdAt: new Date().toISOString(),
        progress: (parseFloat(current) / parseFloat(target)) * 100
    };
    
    financialGoals.push(goal);
    saveFinancialGoals();
    renderFinancialGoals();
    updateAdvancedAnalytics();
    
    return goal;
}

// Atualizar meta existente
function updateFinancialGoal(id, updates) {
    const index = financialGoals.findIndex(g => g.id === id);
    if (index !== -1) {
        const updatedGoal = {
            ...financialGoals[index],
            ...updates,
            updatedAt: new Date().toISOString()
        };
        
        // Recalcular progresso
        updatedGoal.progress = (updatedGoal.current / updatedGoal.target) * 100;
        
        financialGoals[index] = updatedGoal;
        saveFinancialGoals();
        renderFinancialGoals();
        updateAdvancedAnalytics();
        return true;
    }
    return false;
}

// Remover meta
function deleteFinancialGoal(id) {
    if (confirm('Tem certeza que deseja excluir esta meta?')) {
        financialGoals = financialGoals.filter(g => g.id !== id);
        saveFinancialGoals();
        renderFinancialGoals();
        updateAdvancedAnalytics();
    }
}

// Renderizar lista de metas
function renderFinancialGoals() {
    goalsList.innerHTML = '';
    
    if (financialGoals.length === 0) {
        goalsList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-bullseye"></i>
                <p>Nenhuma meta financeira definida</p>
                <p>Clique em "Nova Meta" para começar</p>
            </div>
        `;
        return;
    }
    
    // Ordenar por deadline mais próximo
    const sortedGoals = [...financialGoals].sort((a, b) => {
        return new Date(a.deadline) - new Date(b.deadline);
    });
    
    sortedGoals.forEach(goal => {
        const goalElement = document.createElement('div');
        goalElement.className = 'goal-item';
        
        const deadlineDate = new Date(goal.deadline);
        const today = new Date();
        const daysRemaining = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));
        
        // Determinar cor da borda baseada no progresso
        let borderColor = '#3498db'; // Azul padrão
        if (goal.progress >= 100) {
            borderColor = '#27ae60'; // Verde - meta alcançada
        } else if (goal.progress >= 75) {
            borderColor = '#f39c12'; // Laranja - perto de alcançar
        } else if (goal.progress >= 50) {
            borderColor = '#3498db'; // Azul - progresso bom
        } else if (daysRemaining < 30) {
            borderColor = '#e74c3c'; // Vermelho - prazo curto
        }
        
        goalElement.style.borderLeftColor = borderColor;
        
        goalElement.innerHTML = `
            <div class="goal-header">
                <div class="goal-title">
                    <i class="fas fa-bullseye"></i>
                    ${goal.title}
                    <span style="font-size: 0.8em; color: #7f8c8d;">(${goal.category})</span>
                </div>
                <div class="goal-amount">${formatCurrency(goal.target)}</div>
            </div>
            
            <div class="goal-progress">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${Math.min(goal.progress, 100)}%"></div>
                </div>
                <div class="goal-details">
                    <span>${formatCurrency(goal.current)} de ${formatCurrency(goal.target)}</span>
                    <span>${goal.progress.toFixed(1)}% concluído</span>
                    <span>${daysRemaining > 0 ? `${daysRemaining} dias restantes` : 'Prazo expirado'}</span>
                </div>
            </div>
            
            <div class="goal-actions">
                <button class="btn-edit-goal edit-goal" data-id="${goal.id}">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <button class="btn-delete-goal delete-goal" data-id="${goal.id}">
                    <i class="fas fa-trash-alt"></i> Excluir
                </button>
            </div>
        `;
        
        goalsList.appendChild(goalElement);
    });
    
    // Adicionar event listeners
    document.querySelectorAll('.edit-goal').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = e.currentTarget.getAttribute('data-id');
            editFinancialGoal(id);
        });
    });
    
    document.querySelectorAll('.delete-goal').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = e.currentTarget.getAttribute('data-id');
            deleteFinancialGoal(id);
        });
    });
}

// Editar meta
function editFinancialGoal(id) {
    const goal = financialGoals.find(g => g.id === id);
    if (!goal) return;
    
    goalEditMode = true;
    currentGoalEditId = id;
    
    goalModalTitle.textContent = 'Editar Meta Financeira';
    goalTitleInput.value = goal.title;
    goalTargetInput.value = goal.target;
    goalCurrentInput.value = goal.current;
    goalDeadlineInput.value = goal.deadline;
    goalCategoryInput.value = goal.category;
    
    goalModalOverlay.style.display = 'flex';
}

// Configurar modal de metas
function setupGoalModal() {
    // Abrir modal para nova meta
    addGoalBtn.addEventListener('click', () => {
        goalEditMode = false;
        currentGoalEditId = null;
        goalModalTitle.textContent = 'Nova Meta Financeira';
        
        // Resetar campos
        goalTitleInput.value = '';
        goalTargetInput.value = '';
        goalCurrentInput.value = '0';
        goalDeadlineInput.valueAsDate = new Date(new Date().setMonth(new Date().getMonth() + 6)); // 6 meses a partir de hoje
        goalCategoryInput.value = 'economia';
        
        goalModalOverlay.style.display = 'flex';
    });
    
    // Fechar modal
    closeGoalModal.addEventListener('click', () => {
        goalModalOverlay.style.display = 'none';
    });
    
    cancelGoalModal.addEventListener('click', () => {
        goalModalOverlay.style.display = 'none';
    });
    
    // Salvar meta
    saveGoalBtn.addEventListener('click', () => {
        const title = goalTitleInput.value.trim();
        const target = goalTargetInput.value;
        const current = goalCurrentInput.value;
        const deadline = goalDeadlineInput.value;
        const category = goalCategoryInput.value;
        
        if (!title || !target || current === '' || !deadline) {
            alert('Por favor, preencha todos os campos.');
            return;
        }
        
        if (parseFloat(target) <= 0) {
            alert('O valor alvo deve ser maior que zero.');
            return;
        }
        
        if (parseFloat(current) > parseFloat(target)) {
            alert('O valor atual não pode ser maior que o valor alvo.');
            return;
        }
        
        if (goalEditMode) {
            updateFinancialGoal(currentGoalEditId, {
                title,
                target: parseFloat(target),
                current: parseFloat(current),
                deadline,
                category
            });
            
            notificationText.textContent = "Meta atualizada com sucesso!";
        } else {
            addFinancialGoal(title, target, current, deadline, category);
            
            notificationText.textContent = "Meta adicionada com sucesso!";
        }
        
        showExportNotification();
        goalModalOverlay.style.display = 'none';
    });
}

// ============================================
// FUNÇÕES MELHORADAS PARA ANÁLISES AVANÇADAS
// ============================================

// Calcular métricas avançadas (VERSÃO MELHORADA)
function calculateAdvancedMetrics() {
    if (transactions.length === 0) {
        return {
            highestBalance: 0,
            lowestBalance: 0,
            monthlyAverage: 0,
            savingRate: 0,
            highestBalanceDate: '--/--/----',
            lowestBalanceDate: '--/--/----',
            balanceHistory: [],
            monthlyData: []
        };
    }
    
    // Ordenar transações por data (mais antigas primeiro)
    const sortedTransactions = [...transactions].sort((a, b) => 
        new Date(a.date) - new Date(b.date)
    );
    
    // 1. Calcular histórico de saldo por data
    const balanceHistory = [];
    const balancesByDate = new Map(); // Para agrupar por data
    
    let runningBalance = 0;
    
    sortedTransactions.forEach(transaction => {
        const date = new Date(transaction.date);
        // Formatar data como DD/MM/YYYY
        const dateKey = date.toLocaleDateString('pt-BR');
        
        // Inicializar se for nova data
        if (!balancesByDate.has(dateKey)) {
            balancesByDate.set(dateKey, { income: 0, expense: 0 });
        }
        
        const dateData = balancesByDate.get(dateKey);
        
        if (transaction.type === 'income') {
            dateData.income += transaction.value;
            runningBalance += transaction.value;
        } else {
            const expenseValue = Math.abs(transaction.value);
            dateData.expense += expenseValue;
            runningBalance -= expenseValue;
        }
        
        // Atualizar saldo para esta data
        dateData.balance = runningBalance;
    });
    
    // Converter Map para array e ordenar por data
    const sortedDates = Array.from(balancesByDate.keys()).sort((a, b) => {
        const [dayA, monthA, yearA] = a.split('/').map(Number);
        const [dayB, monthB, yearB] = b.split('/').map(Number);
        return new Date(yearA, monthA - 1, dayA) - new Date(yearB, monthB - 1, dayB);
    });
    
    // Criar array de histórico de saldo
    sortedDates.forEach(dateStr => {
        const dateData = balancesByDate.get(dateStr);
        balanceHistory.push({
            date: dateStr,
            balance: dateData.balance
        });
    });
    
    // 2. Calcular métricas do histórico
    let highestBalance = -Infinity;
    let lowestBalance = Infinity;
    let highestBalanceDate = '';
    let lowestBalanceDate = '';
    
    balanceHistory.forEach(item => {
        if (item.balance > highestBalance) {
            highestBalance = item.balance;
            highestBalanceDate = item.date;
        }
        if (item.balance < lowestBalance) {
            lowestBalance = item.balance;
            lowestBalanceDate = item.date;
        }
    });
    
    // Se não houver histórico, usar valores padrão
    if (balanceHistory.length === 0) {
        highestBalance = 0;
        lowestBalance = 0;
        highestBalanceDate = '--/--/----';
        lowestBalanceDate = '--/--/----';
    }
    
    // 3. Calcular dados mensais (últimos 6 meses)
    const monthlyData = calculateMonthlyData();
    
    // Calcular média mensal dos últimos 6 meses
    const last6Months = monthlyData.slice(-6);
    const monthlyAverage = last6Months.length > 0 
        ? last6Months.reduce((sum, month) => sum + month.balance, 0) / last6Months.length
        : 0;
    
    // 4. Calcular taxa de economia
    const totalIncome = transactions
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + t.value, 0);
    
    const totalExpense = transactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + Math.abs(t.value), 0);
    
    const savingRate = totalIncome > 0 
        ? ((totalIncome - totalExpense) / totalIncome) * 100
        : 0;
    
    return {
        highestBalance,
        lowestBalance,
        monthlyAverage,
        savingRate,
        highestBalanceDate,
        lowestBalanceDate,
        balanceHistory,
        monthlyData
    };
}

// Calcular dados mensais (VERSÃO MELHORADA)
function calculateMonthlyData() {
    const monthlyMap = new Map();
    
    // Adicionar os últimos 6 meses mesmo se não houver transações
    const today = new Date();
    for (let i = 0; i < 6; i++) {
        const monthDate = new Date(today.getFullYear(), today.getMonth() - i, 1);
        const monthKey = `${monthDate.getMonth() + 1}/${monthDate.getFullYear()}`;
        
        if (!monthlyMap.has(monthKey)) {
            monthlyMap.set(monthKey, {
                month: monthKey,
                income: 0,
                expense: 0,
                balance: 0
            });
        }
    }
    
    // Processar transações
    transactions.forEach(transaction => {
        const date = new Date(transaction.date);
        const monthKey = `${date.getMonth() + 1}/${date.getFullYear()}`;
        
        if (!monthlyMap.has(monthKey)) {
            monthlyMap.set(monthKey, {
                month: monthKey,
                income: 0,
                expense: 0,
                balance: 0
            });
        }
        
        const monthData = monthlyMap.get(monthKey);
        
        if (transaction.type === 'income') {
            monthData.income += transaction.value;
            monthData.balance += transaction.value;
        } else {
            const expenseValue = Math.abs(transaction.value);
            monthData.expense += expenseValue;
            monthData.balance -= expenseValue;
        }
    });
    
    // Converter para array e ordenar por data
    return Array.from(monthlyMap.values())
        .sort((a, b) => {
            const [aMonth, aYear] = a.month.split('/').map(Number);
            const [bMonth, bYear] = b.month.split('/').map(Number);
            return (aYear - bYear) * 12 + (aMonth - bMonth);
        })
        .slice(-12); // Últimos 12 meses
}

// Atualizar gráfico de histórico de saldo (VERSÃO MELHORADA)
function updateBalanceHistoryChart(balanceHistory) {
    if (balanceHistoryChart) {
        balanceHistoryChart.destroy();
    }
    
    if (balanceHistory.length === 0) {
        balanceHistoryChart = new Chart(balanceHistoryChartCanvas, {
            type: 'line',
            data: {
                datasets: [{
                    data: [0],
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    borderColor: '#3498db',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false },
                    beforeDraw: function(chart) {
                        const ctx = chart.ctx;
                        const width = chart.width;
                        const height = chart.height;
                        
                        ctx.restore();
                        ctx.font = "14px 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillStyle = '#7f8c8d';
                        ctx.fillText('Nenhum dado disponível', width / 2, height / 2);
                        ctx.save();
                    }
                }
            }
        });
        return;
    }
    
    // Limitar a 30 pontos para não sobrecarregar o gráfico
    const maxPoints = 30;
    let labels = [];
    let data = [];
    
    if (balanceHistory.length > maxPoints) {
        // Amostrar dados para muitos pontos
        const step = Math.ceil(balanceHistory.length / maxPoints);
        for (let i = 0; i < balanceHistory.length; i += step) {
            labels.push(balanceHistory[i].date);
            data.push(balanceHistory[i].balance);
        }
    } else {
        labels = balanceHistory.map(item => item.date);
        data = balanceHistory.map(item => item.balance);
    }
    
    // Adicionar linha de tendência (opcional)
    const trendLineData = calculateTrendLine(data);
    
    balanceHistoryChart = new Chart(balanceHistoryChartCanvas, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Saldo',
                    data: data,
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    borderColor: '#3498db',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#3498db',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                },
                {
                    label: 'Tendência',
                    data: trendLineData,
                    borderColor: 'rgba(231, 76, 60, 0.7)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0,
                    tension: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += formatCurrency(context.parsed.y);
                            return label;
                        },
                        title: function(tooltipItems) {
                            return `Data: ${tooltipItems[0].label}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Data',
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    },
                    ticks: {
                        maxTicksLimit: 10,
                        font: {
                            size: 10
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Saldo (R$)',
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    },
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR', { 
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 0
                            });
                        },
                        font: {
                            size: 10
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
}

// Calcular linha de tendência
function calculateTrendLine(data) {
    if (data.length < 2) return data;
    
    const n = data.length;
    let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
    
    for (let i = 0; i < n; i++) {
        sumX += i;
        sumY += data[i];
        sumXY += i * data[i];
        sumX2 += i * i;
    }
    
    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
    const intercept = (sumY - slope * sumX) / n;
    
    const trendData = [];
    for (let i = 0; i < n; i++) {
        trendData.push(slope * i + intercept);
    }
    
    return trendData;
}

// Atualizar gráfico de comparação mensal (VERSÃO MELHORADA)
function updateMonthlyComparisonChart(monthlyData) {
    if (monthlyComparisonChart) {
        monthlyComparisonChart.destroy();
    }
    
    // Garantir que temos pelo menos os últimos 3 meses
    const minMonths = 3;
    let displayData = monthlyData;
    
    if (monthlyData.length < minMonths) {
        // Adicionar meses vazios se necessário
        const today = new Date();
        displayData = [];
        
        for (let i = minMonths - 1; i >= 0; i--) {
            const monthDate = new Date(today.getFullYear(), today.getMonth() - i, 1);
            const monthKey = `${monthDate.getMonth() + 1}/${monthDate.getFullYear()}`;
            
            const existingData = monthlyData.find(d => d.month === monthKey);
            
            if (existingData) {
                displayData.push(existingData);
            } else {
                displayData.push({
                    month: monthKey,
                    income: 0,
                    expense: 0,
                    balance: 0
                });
            }
        }
    } else {
        // Usar os últimos 12 meses no máximo
        displayData = monthlyData.slice(-12);
    }
    
    if (displayData.length === 0) {
        monthlyComparisonChart = new Chart(monthlyComparisonChartCanvas, {
            type: 'bar',
            data: {
                datasets: [{
                    data: [0],
                    backgroundColor: 'rgba(52, 152, 219, 0.7)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false },
                    beforeDraw: function(chart) {
                        const ctx = chart.ctx;
                        const width = chart.width;
                        const height = chart.height;
                        
                        ctx.restore();
                        ctx.font = "14px 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillStyle = '#7f8c8d';
                        ctx.fillText('Nenhum dado disponível', width / 2, height / 2);
                        ctx.save();
                    }
                }
            }
        });
        return;
    }
    
    const labels = displayData.map(item => {
        const [month, year] = item.month.split('/');
        const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
        return `${monthNames[parseInt(month) - 1]}/${year}`;
    });
    
    const incomeData = displayData.map(item => item.income);
    const expenseData = displayData.map(item => item.expense);
    const balanceData = displayData.map(item => item.balance);
    
    // Calcular médias para linha de referência
    const avgIncome = incomeData.reduce((a, b) => a + b, 0) / incomeData.length;
    const avgExpense = expenseData.reduce((a, b) => a + b, 0) / expenseData.length;
    const avgBalance = balanceData.reduce((a, b) => a + b, 0) / balanceData.length;
    
    monthlyComparisonChart = new Chart(monthlyComparisonChartCanvas, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Renda',
                    data: incomeData,
                    backgroundColor: 'rgba(39, 174, 96, 0.7)',
                    borderColor: '#27ae60',
                    borderWidth: 1,
                    borderRadius: 3
                },
                {
                    label: 'Despesa',
                    data: expenseData,
                    backgroundColor: 'rgba(231, 76, 60, 0.7)',
                    borderColor: '#e74c3c',
                    borderWidth: 1,
                    borderRadius: 3
                },
                {
                    label: 'Saldo',
                    data: balanceData,
                    backgroundColor: 'rgba(52, 152, 219, 0.7)',
                    borderColor: '#3498db',
                    borderWidth: 1,
                    type: 'line',
                    fill: false,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                },
                {
                    label: 'Média Renda',
                    data: Array(labels.length).fill(avgIncome),
                    borderColor: 'rgba(39, 174, 96, 0.3)',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    type: 'line',
                    fill: false,
                    pointRadius: 0,
                    tension: 0
                },
                {
                    label: 'Média Despesa',
                    data: Array(labels.length).fill(avgExpense),
                    borderColor: 'rgba(231, 76, 60, 0.3)',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    type: 'line',
                    fill: false,
                    pointRadius: 0,
                    tension: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: {
                            size: 11
                        },
                        filter: function(item, chart) {
                            // Mostrar apenas legendas principais
                            return !item.text.includes('Média');
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += formatCurrency(context.parsed.y);
                            
                            // Adicionar porcentagem da média para renda/despesa
                            if (context.dataset.label === 'Renda' && avgIncome > 0) {
                                const percent = (context.parsed.y / avgIncome * 100 - 100).toFixed(1);
                                label += ` (${percent >= 0 ? '+' : ''}${percent}% vs média)`;
                            } else if (context.dataset.label === 'Despesa' && avgExpense > 0) {
                                const percent = (context.parsed.y / avgExpense * 100 - 100).toFixed(1);
                                label += ` (${percent >= 0 ? '+' : ''}${percent}% vs média)`;
                            }
                            
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Mês',
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Valor (R$)',
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    },
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR', { 
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 0
                            });
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
}

// Configurar seletor de período
function setupPeriodSelector() {
    periodButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            // Remover classe active de todos
            periodButtons.forEach(b => b.classList.remove('active'));
            
            // Adicionar classe active ao botão clicado
            btn.classList.add('active');
            
            // Atualizar período atual
            currentPeriod = btn.getAttribute('data-period');
            
            // Atualizar análises com o novo período
            updateAdvancedAnalytics();
        });
    });
}

// ============================================
// ATUALIZAÇÃO DA FUNÇÃO updateAdvancedAnalytics
// ============================================

function updateAdvancedAnalytics() {
    if (transactions.length === 0) {
        // Resetar métricas se não houver transações
        highestBalanceElem.textContent = 'R$ 0.00';
        lowestBalanceElem.textContent = 'R$ 0.00';
        monthlyAverageElem.textContent = 'R$ 0.00';
        savingRateElem.textContent = '0%';
        highestBalanceDateElem.textContent = '--/--/----';
        lowestBalanceDateElem.textContent = '--/--/----';
        
        // Limpar gráficos
        if (balanceHistoryChart) balanceHistoryChart.destroy();
        if (monthlyComparisonChart) monthlyComparisonChart.destroy();
        
        // Mostrar gráficos vazios
        updateBalanceHistoryChart([]);
        updateMonthlyComparisonChart([]);
        return;
    }
    
    // Calcular métricas com as funções melhoradas
    const metrics = calculateAdvancedMetrics();
    
    // Atualizar elementos de métricas
    highestBalanceElem.textContent = formatCurrency(metrics.highestBalance);
    lowestBalanceElem.textContent = formatCurrency(metrics.lowestBalance);
    monthlyAverageElem.textContent = formatCurrency(metrics.monthlyAverage);
    savingRateElem.textContent = `${metrics.savingRate.toFixed(1)}%`;
    highestBalanceDateElem.textContent = metrics.highestBalanceDate;
    lowestBalanceDateElem.textContent = metrics.lowestBalanceDate;
    
    // Atualizar gráficos com as funções melhoradas
    updateBalanceHistoryChart(metrics.balanceHistory);
    updateMonthlyComparisonChart(metrics.monthlyData);
}

// ============================================
// FUNÇÕES DE TRANSAÇÕES REGULARES (ORIGINAIS)
// ============================================

// Carrega as transações do Local Storage ao iniciar
function loadTransactions() {
    const storedTransactions = localStorage.getItem('financialTransactions');
    if (storedTransactions) {
        transactions = JSON.parse(storedTransactions);
        
        // Inicializar propriedade 'paga' para transações antigas
        transactions.forEach(transaction => {
            if (transaction.type === 'expense' && transaction.paga === undefined) {
                transaction.paga = false;
            }
            // Garantir que todas as transações tenham uma data
            if (!transaction.date) {
                transaction.date = new Date(transaction.id).toISOString().split('T')[0];
            }
        });
    }
    updateUI();
}

// Salva as transações no Local Storage
function saveTransactions() {
    localStorage.setItem('financialTransactions', JSON.stringify(transactions));
}

// Valida se a categoria é compatível com o tipo de transação
function validateCategory(type, category) {
    if (type === 'income') {
        return incomeCategories.includes(category);
    } else {
        return expenseCategories.includes(category);
    }
}

// Mostra mensagem de erro na categoria
function showCategoryError(message) {
    categoryError.textContent = message;
    categoryError.style.display = 'block';
    categoryInput.parentElement.classList.add('error');
}

// Esconde a mensagem de erro na categoria
function hideCategoryError() {
    categoryError.style.display = 'none';
    categoryInput.parentElement.classList.remove('error');
}

function formatDate(dateString) {
    // Converte de YYYY-MM-DD para DD/MM/YYYY
    const [year, month, day] = dateString.split('-');
    return `${day}/${month}/${year}`;
}

// Adiciona uma nova transação
function addTransaction(type) {
    const description = descriptionInput.value.trim();
    const value = parseFloat(valueInput.value);
    const category = categoryInput.value;
    const date = transactionDateInput.value;
    
    // Resetar mensagens de erro
    hideCategoryError();

    if (!description || isNaN(value) || value <= 0 || !category || !date) {
        alert('Por favor, preencha todos os campos com valores válidos.');
        return;
    }
    
    // Validar categoria compatível com o tipo
    if (!validateCategory(type, category)) {
        let message = '';
        if (type === 'income') {
            message = 'Selecione uma categoria de renda válida';
        } else {
            message = 'Selecione uma categoria de despesa válida';
        }
        showCategoryError(message);
        return;
    }

    // Gerar ID único combinando timestamp com número aleatório
    const uniqueId = Date.now() + '-' + Math.floor(Math.random() * 1000);
    
    const transaction = {
        id: uniqueId, // ID único para evitar conflitos
        description,
        category,
        value: type === 'expense' ? -value : value,
        type,
        date,
        ...(type === 'expense' && { paga: false })
    };

    transactions.push(transaction);
    saveTransactions();
    updateUI();
    clearInputs();
}

// Atualiza uma transação existente
function updateTransaction() {
    const description = descriptionInput.value.trim();
    const value = parseFloat(valueInput.value);
    const category = categoryInput.value;
    const date = transactionDateInput.value;
    
    // Resetar mensagens de erro
    hideCategoryError();

    if (!description || isNaN(value) || value <= 0 || !category || !date) {
        alert('Por favor, preencha todos os campos com valores válidos.');
        return;
    }
    
    // Validar categoria compatível com o tipo
    if (!validateCategory(currentTransactionType, category)) {
        let message = '';
        if (currentTransactionType === 'income') {
            message = 'Selecione uma categoria de renda válida';
        } else {
            message = 'Selecione uma categoria de despesa válida';
        }
        showCategoryError(message);
        return;
    }

    // Encontra o índice da transação sendo editada
    const index = transactions.findIndex(t => t.id === currentEditId);
    
    if (index !== -1) {
        transactions[index].description = description;
        transactions[index].value = currentTransactionType === 'expense' ? -value : value;
        transactions[index].category = category;
        transactions[index].date = date;
        const dateParts = date.split('-');
        const correctedDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
        
        saveTransactions();
        updateUI();
        cancelEditMode();
    }
}

// Remove uma transação
function deleteTransaction(id) {
    if (confirm('Tem certeza que deseja excluir esta transação?')) {
        // Encontrar o índice exato da transação com o ID completo
        const index = transactions.findIndex(transaction => transaction.id === id);
        
        if (index !== -1) {
            transactions.splice(index, 1);
            saveTransactions();
            updateUI();
            
            // Se estava em modo de edição para esta transação, cancelar o modo de edição
            if (isEditMode && currentEditId === id) {
                cancelEditMode();
            }
            
            notificationText.textContent = "Transação excluída com sucesso!";
            showExportNotification();
        } else {
            alert('Transação não encontrada!');
        }
    }
}

// Ativa o modo de edição
function activateEditMode(id) {
    // Encontrar a transação pelo ID completo
    const transaction = transactions.find(t => t.id === id);
    
    if (transaction) {
        isEditMode = true;
        currentEditId = id;
        currentTransactionType = transaction.type;
        
        // Preencher os campos com os dados da transação
        descriptionInput.value = transaction.description;
        valueInput.value = Math.abs(transaction.value);
        categoryInput.value = transaction.category;
        transactionDateInput.value = transaction.date;
        
        // Atualizar as categorias disponíveis conforme o tipo
        populateCategories();
        
        // Garantir que a categoria selecionada está visível
        setTimeout(() => {
            categoryInput.value = transaction.category;
        }, 10);
        
        // Mostrar botões de atualização/cancelamento
        editModeSection.style.display = 'flex';
        
        // Destacar visualmente o tipo de transação sendo editada
        if (transaction.type === 'income') {
            addIncomeBtn.classList.add('active-edit');
            addExpenseBtn.classList.remove('active-edit');
        } else {
            addExpenseBtn.classList.add('active-edit');
            addIncomeBtn.classList.remove('active-edit');
        }
        
        // Rolar até o formulário
        descriptionInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Focar no campo de descrição
        descriptionInput.focus();
    }
}

// Cancela o modo de edição
function cancelEditMode() {
    isEditMode = false;
    currentEditId = null;
    currentTransactionType = null;
    editModeSection.style.display = 'none';
    clearInputs();
    hideCategoryError();
}

// Atualiza a interface do usuário (tabela, resumos e gráficos)
function updateUI() {
    updateSummary();
    renderTransactionsTable();
    updateCharts();
    updateFinancialHealthMessage();
    updateTransactionsIndicator();
    updateAdvancedAnalytics();
}

// Atualiza os totais de renda, despesa e saldo
function updateSummary() {
    let totalIncome = 0;
    let totalExpense = 0;
    let totalPaid = 0;
    let totalPending = 0;
    let realBalance = 0; // Novo saldo atual (considera apenas o que foi pago)

    transactions.forEach(transaction => {
        if (transaction.type === 'income') {
            totalIncome += transaction.value;
            realBalance += transaction.value; // Rendas sempre entram no saldo atual
        } else {
            const expenseValue = Math.abs(transaction.value);
            totalExpense += expenseValue;
            
            if (transaction.paga) {
                totalPaid += expenseValue;
                realBalance -= expenseValue; // Despesas pagas saem do saldo atual
            } else {
                totalPending += expenseValue;
            }
        }
    });

    const currentBalance = totalIncome - totalExpense;

    // Atualizar os elementos na tela
    totalIncomeElem.textContent = formatCurrency(totalIncome);
    totalExpenseElem.textContent = formatCurrency(totalExpense);
    currentBalanceElem.textContent = formatCurrency(currentBalance);
    realBalanceElem.textContent = formatCurrency(realBalance); // Novo saldo atual
    totalPaidElem.textContent = formatCurrency(totalPaid);
    totalPendingElem.textContent = formatCurrency(totalPending);
    
    // Altera a cor do saldo conforme o valor
    function updateBalanceColor(element, value) {
        if (element.id === 'real-balance') {
            // Cores específicas para o Saldo Atual
            if (value > 0) {
                element.style.color = '#F39C12'; // Laranja para positivo
            } else if (value < 0) {
                element.style.color = '#e74c3c'; // Vermelho para negativo
            } else {
                element.style.color = '#3498db'; // Azul para zero
            }
        } else {
            // Mantém as cores originais para outros elementos
            if (value > 0) {
                element.style.color = '#27ae60'; // Verde
            } else if (value < 0) {
                element.style.color = '#e74c3c'; // Vermelho
            } else {
                element.style.color = '#3498db'; // Azul
            }
        }
    }
    
    updateBalanceColor(currentBalanceElem, currentBalance);
    updateBalanceColor(realBalanceElem, realBalance);
    
    // Retornar os valores para uso na mensagem de saúde financeira
    return { totalIncome, totalExpense, currentBalance, realBalance };
}

// Renderiza as transações na tabela
function renderTransactionsTable() {
    transactionsTableBody.innerHTML = '';

    // Ordenar transações - rendas primeiro, depois por data (mais recentes primeiro)
    const sortedTransactions = [...transactions].sort((a, b) => {
        // 1. Rendas primeiro (type 'income' vem antes de 'expense')
        if (a.type === 'income' && b.type !== 'income') return -1;
        if (a.type !== 'income' && b.type === 'income') return 1;
        
        // 2. Para transações do mesmo tipo, ordenar por data (mais recente primeiro)
        return new Date(b.date) - new Date(a.date);
    });

    sortedTransactions.forEach(transaction => {
        const row = transactionsTableBody.insertRow();
        
        // Tipo
        const typeCell = row.insertCell();
        typeCell.innerHTML = `<span class="${transaction.type === 'income' ? 'type-income' : 'type-expense'}">${transaction.type === 'income' ? 'Renda' : 'Despesa'}</span>`;
        typeCell.setAttribute('data-label', 'Tipo');

        // Data
        const dateCell = row.insertCell();
        dateCell.textContent = formatDate(transaction.date);
        dateCell.setAttribute('data-label', 'Data');
        
        // Descrição
        const descriptionCell = row.insertCell();
        descriptionCell.textContent = transaction.description;
        descriptionCell.setAttribute('data-label', 'Descrição');
        
        // Categoria
        const categoryCell = row.insertCell();
        categoryCell.innerHTML = `<span class="category-badge">${transaction.category}</span>`;
        categoryCell.setAttribute('data-label', 'Categoria');

        // Valor
        const valueCell = row.insertCell();
        valueCell.textContent = formatCurrency(Math.abs(transaction.value));
        valueCell.setAttribute('data-label', 'Valor');

        // Paga? (apenas para despesas)
        const paidCell = row.insertCell();
        if (transaction.type === 'expense') {
            paidCell.setAttribute('data-label', 'Paga?');
            paidCell.setAttribute('data-is-income', 'false');
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = transaction.paga || false;
            checkbox.addEventListener('change', () => {
                transaction.paga = checkbox.checked;
                saveTransactions();
                updateUI();
            });
            paidCell.appendChild(checkbox);
        } else {
            paidCell.setAttribute('data-label', 'Paga?');
            paidCell.setAttribute('data-is-income', 'true');
            paidCell.textContent = '-';
        }

        // Ações
        const actionsCell = row.insertCell();
        actionsCell.setAttribute('data-label', 'Ações');
        actionsCell.className = 'action-cell';
        
        const editBtn = document.createElement('button');
        editBtn.innerHTML = '<i class="fas fa-edit"></i> <span>Editar</span>';
        editBtn.classList.add('btn', 'btn-edit');
        editBtn.onclick = () => activateEditMode(transaction.id);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i> <span>Excluir</span>';
        deleteBtn.classList.add('btn', 'btn-delete');
        deleteBtn.onclick = () => deleteTransaction(transaction.id);
        
        actionsCell.appendChild(editBtn);
        actionsCell.appendChild(deleteBtn);
    });
}

// Atualiza os gráficos
function updateCharts() {
    // Calcular valores para os gráficos
    const expenseByCategory = {};
    let totalIncome = 0;
    let totalExpense = 0;
    
    transactions.forEach(t => {
        if (t.type === 'income') {
            totalIncome += t.value;
        } else {
            totalExpense += Math.abs(t.value);
            
            // Agrupar despesas por categoria
            expenseByCategory[t.category] = (expenseByCategory[t.category] || 0) + Math.abs(t.value);
        }
    });
    
    const currentBalance = totalIncome - totalExpense;
    
    // Calcular porcentagens para o gráfico de barras
    const incomePercent = totalIncome > 0 ? 100 : 0;
    const expensePercent = totalIncome > 0 ? (totalExpense / totalIncome) * 100 : 0;
    const balancePercent = totalIncome > 0 ? (currentBalance / totalIncome) * 100 : 0;
    
    // Atualizar gráfico de despesas
    updateExpenseChart(Object.keys(expenseByCategory), Object.values(expenseByCategory));
    
    // Atualizar gráfico de porcentagens
    updateSummaryChart(incomePercent, expensePercent, balancePercent);
}

// Atualizar gráfico de despesas (pizza)
function updateExpenseChart(labels, data) {
    if (expenseChart) {
        expenseChart.destroy();
    }
    
    // Se não houver despesas, exibir mensagem
    if (data.length === 0) {
        expenseChart = new Chart(expenseChartCanvas, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [1],
                    backgroundColor: ['#f0f0f0']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false },
                    beforeDraw: function(chart) {
                        const ctx = chart.ctx;
                        const width = chart.width;
                        const height = chart.height;
                        
                        ctx.restore();
                        ctx.font = "16px 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillStyle = '#7f8c8d';
                        ctx.fillText('Nenhuma despesa registrada', width / 2, height / 2);
                        ctx.save();
                    }
                }
            }
        });
        return;
    }

    expenseChart = new Chart(expenseChartCanvas, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
                    '#8D6E63', '#4DD0E1', '#F44336', '#9C27B0'
                ],
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        font: {
                            size: 11
                        },
                        color: '#555'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed !== null) {
                                label += formatCurrency(context.parsed);
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
}

// Atualizar gráfico de porcentagens (barras horizontais)
function updateSummaryChart(incomePercent, expensePercent, balancePercent) {
    if (summaryChart) {
        summaryChart.destroy();
    }

    summaryChart = new Chart(summaryChartCanvas, {
        type: 'bar',
        data: {
            labels: ['Rendas', 'Gastos', 'Saldo'],
            datasets: [{
                label: 'Porcentagem em relação à renda total',
                data: [incomePercent, expensePercent, balancePercent],
                backgroundColor: [
                    'rgba(39, 174, 96, 0.7)',   // Verde para rendas
                    'rgba(231, 76, 60, 0.7)',   // Vermelho para gastos
                    'rgba(52, 152, 219, 0.7)'   // Azul para saldo
                ],
                borderColor: [
                    'rgba(39, 174, 96, 1)',
                    'rgba(231, 76, 60, 1)',
                    'rgba(52, 152, 219, 1)'
                ],
                borderWidth: 1
        }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.parsed.x.toFixed(1)}%`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Porcentagem (%)',
                        font: {
                            size: 14
                        }
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}

// Atualiza a mensagem de saúde financeira
function updateFinancialHealthMessage() {
    const { totalIncome, totalExpense, currentBalance } = updateSummary();
    
    let message = "";
    let icon = "";
    let healthClass = "health-neutral";
    
    // Se não há transações
    if (transactions.length === 0) {
        message = "Adicione transações para analisar sua saúde financeira";
        icon = "fas fa-info-circle";
        healthClass = "health-neutral";
    }
    // Saldo negativo
    else if (currentBalance < 0) {
        message = "Cuidado! Seu saldo está negativo. Considere reduzir despesas ou aumentar rendas.";
        icon = "fas fa-exclamation-triangle";
        healthClass = "health-critical";
    }
    // Despesas > 75% da renda
    else if (totalIncome > 0 && (totalExpense / totalIncome) > 0.75) {
        message = "Atenção! Suas despesas estão acima de 75% da sua renda. Tente reduzir custos.";
        icon = "fas fa-exclamation-circle";
        healthClass = "health-warning";
    }
    // Despesas entre 50% e 75% da renda
    else if (totalIncome > 0 && (totalExpense / totalIncome) > 0.5) {
        message = "Sua saúde financeira está estável, mas você pode melhorar. Tente economizar mais.";
        icon = "fas fa-balance-scale";
        healthClass = "health-neutral";
    }
    // Situação saudável
    else {
        message = "Parabéns! Sua saúde financeira está excelente. Continue assim!";
        icon = "fas fa-check-circle";
        healthClass = "health-positive";
    }
    
    // Atualizar o elemento HTML
    financialHealthMessage.innerHTML = `<i class="${icon}"></i><span>${message}</span>`;
    financialHealthMessage.className = `health-message ${healthClass}`;
}

// Limpa os campos de entrada
function clearInputs() {
    descriptionInput.value = '';
    valueInput.value = '';
    categoryInput.value = '';
    transactionDateInput.valueAsDate = new Date(); // Reset para data atual
    descriptionInput.focus();
    hideCategoryError();
}

// Formata o valor para moeda brasileira
function formatCurrency(value) {
    return value.toLocaleString('pt-BR', { 
        style: 'currency', 
        currency: 'BRL',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// Preencher o select de categorias com grupos
function populateCategories() {
    categoryInput.innerHTML = '<option value="" disabled selected>Selecione uma categoria</option>';
    
    // Grupo de Renda
    const incomeGroup = document.createElement('optgroup');
    incomeGroup.label = 'Renda';
    incomeCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        incomeGroup.appendChild(option);
    });
    categoryInput.appendChild(incomeGroup);
    
    // Grupo de Despesas
    const expenseGroup = document.createElement('optgroup');
    expenseGroup.label = 'Despesas';
    expenseCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        expenseGroup.appendChild(option);
    });
    categoryInput.appendChild(expenseGroup);
}

// Atualiza o indicador de transações
function updateTransactionsIndicator() {
    transactionsIndicator.textContent = transactions.length;
}

// ============================================
// FUNÇÕES DE EXPORTAÇÃO/IMPORTAÇÃO (ORIGINAIS)
// ============================================
    
    // Calcular totais incluindo o realBalance
    let totalIncome = 0;
    let totalExpense = 0;
    let totalPaid = 0;
    let totalPending = 0;
    let realBalance = 0;
    
    transactions.forEach(transaction => {
        if (transaction.type === 'income') {
            totalIncome += transaction.value;
            realBalance += transaction.value;
        } else {
            const expenseValue = Math.abs(transaction.value);
            totalExpense += expenseValue;
            
            if (transaction.paga) {
                totalPaid += expenseValue;
                realBalance -= expenseValue;
            } else {
                totalPending += expenseValue;
            }
        }
    });
    
    const currentBalance = totalIncome - totalExpense;
    

// Exportar dados para JSON
function exportToJSON() {
    // Verificar se existem transações
    if (transactions.length === 0) {
        alert('Não há transações para exportar!');
        return;
    }
    
    // Criar objeto com os dados a serem exportados
    const exportData = {
        app: "Controle Financeiro",
        version: "1.0",
        timestamp: new Date().toISOString(),
        transactions: transactions,
        recurringTransactions: recurringTransactions,
        financialGoals: financialGoals // Incluir metas financeiras
    };
    
    // Criar string JSON formatada
    const jsonData = JSON.stringify(exportData, null, 2);
    
    // Criar blob e link de download
    const blob = new Blob([jsonData], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `dados-financeiros-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    notificationText.textContent = "Dados exportados para JSON com sucesso!";
    showExportNotification();
}

// Importar dados de um arquivo JSON
function importFromJSON(file, option) {
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            
            // Validar a estrutura do arquivo
            if (!data.transactions || !Array.isArray(data.transactions)) {
                throw new Error("Formato de arquivo inválido");
            }
            
            // Processar os dados conforme a opção selecionada
            if (option === "replace") {
                transactions = data.transactions;
                // Importar transações recorrentes se existirem
                if (data.recurringTransactions && Array.isArray(data.recurringTransactions)) {
                    recurringTransactions = data.recurringTransactions;
                }
                // Importar metas financeiras se existirem
                if (data.financialGoals && Array.isArray(data.financialGoals)) {
                    financialGoals = data.financialGoals;
                }
            } else { // merge
                // Mesclar transações, evitando duplicatas por ID
                const existingIds = transactions.map(t => t.id);
                const newTransactions = data.transactions.filter(t => !existingIds.includes(t.id));
                transactions = [...transactions, ...newTransactions];
                
                // Mesclar transações recorrentes
                if (data.recurringTransactions && Array.isArray(data.recurringTransactions)) {
                    const existingRecurringIds = recurringTransactions.map(t => t.id);
                    const newRecurringTransactions = data.recurringTransactions.filter(t => !existingRecurringIds.includes(t.id));
                    recurringTransactions = [...recurringTransactions, ...newRecurringTransactions];
                }
                
                // Mesclar metas financeiras
                if (data.financialGoals && Array.isArray(data.financialGoals)) {
                    const existingGoalIds = financialGoals.map(t => t.id);
                    const newGoals = data.financialGoals.filter(t => !existingGoalIds.includes(t.id));
                    financialGoals = [...financialGoals, ...newGoals];
                }
            }
            
            // Salvar e atualizar
            saveTransactions();
            saveRecurringTransactions();
            saveFinancialGoals();
            updateUI();
            renderRecurringTransactions();
            renderFinancialGoals();
            
            notificationText.textContent = `Dados importados com sucesso! (${data.transactions.length} transações)`;
            showExportNotification();
            
            // Fechar o modal de importação
            importOverlay.style.display = 'none';
            
        } catch (error) {
            console.error("Erro ao importar dados:", error);
            alert("Erro ao importar dados: " + error.message);
        }
    };
    
    reader.onerror = function() {
        alert("Erro ao ler o arquivo");
    };
    
    reader.readAsText(file);
}

// Exportar para PDF
async function exportToPDF() {
    try {
        if (transactions.length === 0) {
            alert('Não há transações para exportar!');
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        
        // Configurações de estilo
        const primaryColor = '#2c3e50';
        const lightColor = '#f8f9fa';
        const lightText = '#ffffff';
        const successColor = '#27ae60';
        const dangerColor = '#e74c3c';
        const mutedColor = '#95a5a6';
        const darkText = '#2c3e50';
        
        const margin = 15;
        const pageWidth = pdf.internal.pageSize.getWidth();
        const contentWidth = pageWidth - 2 * margin;
        let yPos = margin;
        
        // Cabeçalho
        pdf.setFillColor(primaryColor);
        pdf.rect(0, 0, pageWidth, 25, 'F');
        
        pdf.setFontSize(20);
        pdf.setFont('helvetica', 'bold');
        pdf.setTextColor(lightText);
        pdf.text('GG - Controle Financeiro', pageWidth / 2, 15, { align: 'center' });
        
        pdf.setFontSize(10);
        pdf.setFont('helvetica', 'normal');
        pdf.text('Resumo completo das suas finanças', pageWidth / 2, 20, { align: 'center' });
        
        // Resumo Financeiro
        yPos += 20;
        
        pdf.setFontSize(14);
        pdf.setFont('helvetica', 'bold');
        pdf.setTextColor(primaryColor);
        pdf.text('Resumo Financeiro', margin, yPos);
        yPos += 5;
        
        pdf.setFillColor(lightColor);
        pdf.setDrawColor(220, 220, 220);
        pdf.setLineWidth(0.5);
        pdf.roundedRect(margin, yPos, contentWidth, 70, 3, 3, 'FD');
        
        const { totalIncome, totalExpense, currentBalance, realBalance, totalPaid, totalPending } = calculateFinancialSummary();
        
        const col1 = margin + 10;
        const col2 = col1 + 60;
        const col3 = col2 + 60;
        
        pdf.setFontSize(10);
        pdf.setFont('helvetica', 'bold');
        pdf.setTextColor(primaryColor);
        pdf.text('Item', col1, yPos + 12);
        pdf.text('Valor', col2, yPos + 12);
        pdf.text('Detalhes', col3, yPos + 12);
        
        pdf.setDrawColor(200, 200, 200);
        pdf.setLineWidth(0.3);
        pdf.line(col1, yPos + 15, col3 + 40, yPos + 15);
        
        pdf.setFont('helvetica', 'normal');
        const summaryItems = [
            { label: 'Renda Total', value: totalIncome, details: '' },
            { label: 'Despesa Total', value: -totalExpense, details: `${(totalExpense/totalIncome*100).toFixed(1)}% da renda` },
            { label: 'Saldo Final', value: currentBalance, details: `${(currentBalance/totalIncome*100).toFixed(1)}% da renda` },
            { label: 'Saldo Atual', value: realBalance, details: totalPending > 0 ? `${formatCurrencyForPDF(totalPending)} pendentes` : 'Tudo pago' },
            { label: 'Total Pago', value: -totalPaid, details: `${(totalPaid/totalExpense*100).toFixed(1)}% das despesas` },
            { label: 'Total Pendente', value: -totalPending, details: `${(totalPending/totalExpense*100).toFixed(1)}% das despesas` }
        ];
        
        summaryItems.forEach((item, index) => {
            const rowY = yPos + 22 + (index * 8);
            
            pdf.setTextColor(darkText);
            pdf.setFont('helvetica', 'bold');
            pdf.text(item.label, col1, rowY);
            
            const valueColor = item.value >= 0 ? successColor : dangerColor;
            pdf.setTextColor(valueColor);
            pdf.setFont('helvetica', 'bold');
            pdf.text(formatCurrencyForPDF(Math.abs(item.value)), col2, rowY);
            
            pdf.setTextColor(mutedColor);
            pdf.setFont('helvetica', 'normal');
            pdf.text(item.details, col3, rowY);
        });
        
        yPos += 80;
        
        // Transações
        pdf.setFontSize(14);
        pdf.setFont('helvetica', 'bold');
        pdf.setTextColor(primaryColor);
        pdf.text(`Todas as Transações (${transactions.length})`, margin, yPos);
        yPos += 8;
        
        pdf.setFillColor(primaryColor);
        pdf.roundedRect(margin, yPos, contentWidth, 10, 3, 3, 'F');
        
        const headers = ['Data', 'Tipo', 'Descrição', 'Categoria', 'Valor'];
        const colWidths = [22, 20, 70, 35, 25];
        let xPos = margin + 5;
        
        pdf.setFontSize(10);
        pdf.setFont('helvetica', 'bold');
        pdf.setTextColor(lightText);
        
        headers.forEach((header, i) => {
            pdf.text(header, xPos + (i === 4 ? colWidths[i] - 5 : 0), yPos + 7, {
                align: i === 4 ? 'right' : 'left'
            });
            xPos += colWidths[i];
        });
        
        yPos += 12;
        
        pdf.setFont('helvetica', 'normal');
        
        const sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
        let pageCount = 1;
        
        sortedTransactions.forEach((transaction, index) => {
            if (yPos > 270) {
                pdf.addPage();
                pageCount++;
                yPos = margin;
                
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'italic');
                pdf.setTextColor(mutedColor);
                pdf.text(`Continuação... (Página ${pageCount})`, margin, yPos);
                yPos += 10;
                
                pdf.setFillColor(primaryColor);
                pdf.roundedRect(margin, yPos, contentWidth, 10, 3, 3, 'F');
                
                xPos = margin + 5;
                headers.forEach((header, i) => {
                    pdf.setTextColor(lightText);
                    pdf.text(header, xPos + (i === 4 ? colWidths[i] - 5 : 0), yPos + 7, {
                        align: i === 4 ? 'right' : 'left'
                    });
                    xPos += colWidths[i];
                });
                
                yPos += 12;
            }
            
            pdf.setFillColor(index % 2 === 0 ? '#fdfdfd' : lightColor);
            pdf.roundedRect(margin, yPos - 2, contentWidth, 10, 2, 2, 'F');
            
            xPos = margin + 5;
            
            pdf.setTextColor(darkText);
            pdf.setFontSize(9);
            pdf.text(formatDateForPDF(new Date(transaction.date)), xPos, yPos + 7);
            xPos += colWidths[0];
            
            const typeColor = transaction.type === 'income' ? successColor : dangerColor;
            pdf.setTextColor(typeColor);
            pdf.setFont('helvetica', 'bold');
            pdf.text(transaction.type === 'income' ? 'Renda' : 'Despesa', xPos, yPos + 7);
            xPos += colWidths[1];
            
            pdf.setTextColor(darkText);
            pdf.setFont('helvetica', 'normal');
            const maxDescWidth = 68;
            let desc = transaction.description;
            const descWidth = pdf.getStringUnitWidth(desc) * (pdf.internal.getFontSize() / pdf.internal.scaleFactor);
            
            if (descWidth > maxDescWidth) {
                while ((pdf.getStringUnitWidth(desc + '...') * (pdf.internal.getFontSize() / pdf.internal.scaleFactor)) > maxDescWidth && desc.length > 3) {
                    desc = desc.substring(0, desc.length - 1);
                }
                desc += '...';
            }
            pdf.text(desc, xPos, yPos + 7);
            xPos += colWidths[2];
            
            pdf.setTextColor(mutedColor);
            pdf.text(transaction.category, xPos, yPos + 7);
            xPos += colWidths[3];
            
            const value = Math.abs(transaction.value);
            const valueColor = transaction.type === 'income' ? successColor : dangerColor;
            pdf.setTextColor(valueColor);
            pdf.setFont('helvetica', 'bold');
            pdf.text(formatCurrencyForPDF(value), xPos + colWidths[4] - 5, yPos + 7, { align: 'right' });
            
            yPos += 10;
        });
        
        // Metas Financeiras (se existirem)
        if (financialGoals.length > 0) {
            yPos += 20;
            
            pdf.setFontSize(14);
            pdf.setFont('helvetica', 'bold');
            pdf.setTextColor(primaryColor);
            pdf.text('Metas Financeiras', margin, yPos);
            yPos += 8;
            
            financialGoals.forEach((goal, index) => {
                if (yPos > 270) {
                    pdf.addPage();
                    pageCount++;
                    yPos = margin;
                    
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'italic');
                    pdf.setTextColor(mutedColor);
                    pdf.text(`Continuação... (Página ${pageCount})`, margin, yPos);
                    yPos += 10;
                }
                
                pdf.setFillColor(index % 2 === 0 ? '#fdfdfd' : lightColor);
                pdf.roundedRect(margin, yPos - 2, contentWidth, 15, 2, 2, 'F');
                
                pdf.setFontSize(9);
                pdf.setTextColor(darkText);
                pdf.setFont('helvetica', 'bold');
                pdf.text(goal.title, margin + 5, yPos + 5);
                
                pdf.setTextColor(mutedColor);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`${formatCurrencyForPDF(goal.current)} de ${formatCurrencyForPDF(goal.target)} (${goal.progress.toFixed(1)}%)`, 
                        margin + 5, yPos + 12);
                
                // Barra de progresso simplificada
                const progressWidth = (goal.progress / 100) * (contentWidth - 10);
                pdf.setFillColor(successColor);
                pdf.rect(margin + 5, yPos + 15, progressWidth, 3, 'F');
                
                yPos += 25;
            });
        }
        
        // Rodapé
        const footerY = 287;
        pdf.setFontSize(8);
        pdf.setFont('helvetica', 'italic');
        pdf.setTextColor(mutedColor);
        
        pdf.setDrawColor(220, 220, 220);
        pdf.setLineWidth(0.1);
        pdf.line(margin, footerY - 5, pageWidth - margin, footerY - 5);
        
        const formattedDate = new Date().toLocaleDateString('pt-BR', { 
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });

        pdf.text(`Relatório gerado em ${formattedDate.replace(',', ' às')}`, 
               pageWidth / 2, footerY, { align: 'center' });
        
        const balanceStatus = realBalance >= 0 ? 'Positivo' : 'Negativo';
        pdf.text(`GG Controle Financeiro • ${transactions.length} transações • Saldo ${balanceStatus} • Página ${pageCount} de ${pageCount}`, 
               pageWidth / 2, footerY + 5, { align: 'center' });
        
        const today = new Date();
        const dateString = `${today.getDate()}-${today.getMonth()+1}-${today.getFullYear()}`;
        pdf.save(`Relatorio_Financeiro_${dateString}.pdf`);
        
        notificationText.textContent = "Relatório PDF gerado com sucesso!";
        showExportNotification();
    } catch (error) {
        console.error("Erro ao gerar PDF:", error);
        alert('Ocorreu um erro ao gerar o PDF. Tente novamente.');
    }
}

// Funções auxiliares para PDF
function calculateFinancialSummary() {
    let totalIncome = 0;
    let totalExpense = 0;
    let totalPaid = 0;
    let totalPending = 0;
    let realBalance = 0;
    
    transactions.forEach(transaction => {
        if (transaction.type === 'income') {
            totalIncome += transaction.value;
            realBalance += transaction.value;
        } else {
            const expenseValue = Math.abs(transaction.value);
            totalExpense += expenseValue;
            
            if (transaction.paga) {
                totalPaid += expenseValue;
                realBalance -= expenseValue;
            } else {
                totalPending += expenseValue;
            }
        }
    });
    
    return {
        totalIncome,
        totalExpense,
        currentBalance: totalIncome - totalExpense,
        realBalance,
        totalPaid,
        totalPending
    };
}

function formatCurrencyForPDF(value) {
    return 'R$ ' + value.toLocaleString('pt-BR', { 
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function formatDateForPDF(date) {
    return date.toLocaleDateString('pt-BR', { 
        day: '2-digit', 
        month: '2-digit',
        year: '2-digit'
    }).replace(/\//g, '/');
}

// Mostrar notificação de exportação/importação
function showExportNotification() {
    exportNotification.style.display = 'block';
    setTimeout(() => {
        exportNotification.style.display = 'none';
    }, 3000);
}

// Compartilhar via WhatsApp
function shareOnWhatsApp() {
    // Verificar se existem transações
    if (transactions.length === 0) {
        alert('Adicione transações antes de compartilhar!');
        return;
    }
    
    // Obter os dados resumidos
    let totalIncome = 0;
    let totalExpense = 0;
    let totalPaid = 0;
    let totalPending = 0;
    let realBalance = 0;
    
    transactions.forEach(transaction => {
        if (transaction.type === 'income') {
            totalIncome += transaction.value;
            realBalance += transaction.value;
        } else {
            const expenseValue = Math.abs(transaction.value);
            totalExpense += expenseValue;
            
            if (transaction.paga) {
                totalPaid += expenseValue;
                realBalance -= expenseValue;
            } else {
                totalPending += expenseValue;
            }
        }
    });
    
    const currentBalance = totalIncome - totalExpense;
    const expensePercentage = totalIncome > 0 ? (totalExpense / totalIncome * 100).toFixed(1) : 0;
    const balancePercentage = totalIncome > 0 ? (currentBalance / totalIncome * 100).toFixed(1) : 0;

    // Montar a mensagem para compartilhamento
    let message = `📊 *Resumo Financeiro* 📊\n\n`;
    message += `✅ *Renda Total:* ${formatCurrency(totalIncome)}\n`;
    message += `💸 *Despesa Total:* ${formatCurrency(totalExpense)} (${expensePercentage}% da renda)\n`;
    message += `💰 *Saldo Final:* ${formatCurrency(currentBalance)} (${balancePercentage}% da renda)\n`;
    message += `💳 *Saldo Atual:* ${formatCurrency(realBalance)}\n`;
    message += `✔️ *Total Pago:* ${formatCurrency(totalPaid)}\n`;
    message += `⏳ *Total Pendente:* ${formatCurrency(totalPending)}\n\n`;
    message += `_Gerado em ${new Date().toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}_\n\n`;
    message += `👉 *Dicas de economia:*\n`;
    message += `- Compare Saldo Final com Saldo Atual para planejar pagamentos\n`;
    message += `- Mantenha suas despesas abaixo de 60% da sua renda\n`;
    message += `- Priorize o pagamento das despesas pendentes\n`;
    
    // Montar o link do WhatsApp
    const whatsappLink = `https://wa.me/?text=${encodeURIComponent(message)}`;
    
    // Abrir nova janela para compartilhamento
    window.open(whatsappLink, '_blank');
    
    notificationText.textContent = "Resumo compartilhado via WhatsApp!";
    showExportNotification();
}

// ============================================
// FUNÇÕES DE NOTIFICAÇÃO (ORIGINAIS)
// ============================================

// Carregar configurações de notificação
function loadNotificationSettings() {
    const settings = JSON.parse(localStorage.getItem('notificationSettings')) || {};
    notificationEnabled = settings.enabled || false;
    notificationFrequency = settings.frequency || 'daily';
    notificationTime = settings.time || '18:00';
    
    // Atualizar UI
    enableNotificationsCheckbox.checked = notificationEnabled;
    reminderFrequencySelect.value = notificationFrequency;
    reminderTimeInput.value = notificationTime;
    notificationFrequencyDiv.style.display = notificationEnabled ? 'flex' : 'none';
    
    // Configurar notificações se estiverem ativadas
    if (notificationEnabled) {
        setupNotifications();
    }
}

// Salvar configurações de notificação
function saveNotificationSettings() {
    const settings = {
        enabled: notificationEnabled,
        frequency: notificationFrequency,
        time: notificationTime
    };
    localStorage.setItem('notificationSettings', JSON.stringify(settings));
}

// Configurar notificações
async function setupNotifications() {
    // Limpar intervalo existente
    if (notificationInterval) {
        clearInterval(notificationInterval);
        notificationInterval = null;
    }

    // Verificar suporte a notificações
    if (!("Notification" in window)) {
        console.log("Este navegador não suporta notificações desktop");
        return;
    }

    // Se notificações estão desativadas, não fazer nada
    if (!notificationEnabled) return;

    // Solicitar permissão se necessário
    if (Notification.permission === "default") {
        try {
            const permission = await Notification.requestPermission();
            if (permission === "granted") {
                scheduleNotifications();
            } else {
                console.log("Permissão para notificações negada");
                showInAppReminder(); // Fallback para notificação in-app
            }
        } catch (error) {
            console.error("Erro ao solicitar permissão:", error);
            showInAppReminder(); // Fallback para notificação in-app
        }
    } else if (Notification.permission === "granted") {
        scheduleNotifications();
    } else {
        showInAppReminder(); // Fallback para notificação in-app
    }
}

// Agendar notificações
function scheduleNotifications() {
    // Converter horário configurado para minutos desde meia-noite
    const [hours, minutes] = notificationTime.split(':').map(Number);
    const notificationTimeInMinutes = hours * 60 + minutes;

    // Função para verificar se é hora da notificação
    function checkNotificationTime() {
        const now = new Date();
        const currentMinutes = now.getHours() * 60 + now.getMinutes();
        
        // Verificar se é o horário exato (com margem de 1 minuto)
        if (Math.abs(currentMinutes - notificationTimeInMinutes) <= 1) {
            showNotification();
        }
    }

    // Verificar imediatamente (pode já ser hora)
    checkNotificationTime();

    // Configurar verificação a cada minuto
    notificationInterval = setInterval(checkNotificationTime, 60 * 1000);
}

// Mostrar notificação
function showNotification() {
    // Verificar se já mostramos notificação hoje
    const lastNotificationDate = localStorage.getItem('lastNotificationDate');
    const today = new Date().toDateString();
    
    if (lastNotificationDate === today) return;

    // Verificar se há transações hoje
    const hasTransactionsToday = checkTodaysActivity();

    if (!hasTransactionsToday) {
        try {
            const notification = new Notification("GG - Controle Financeiro", {
                body: "Lembrete: Registre suas finanças hoje!",
                icon: "https://cdn-icons-png.flaticon.com/512/3132/3132693.png",
                vibrate: [200, 100, 200]
            });

            // Marcar que mostramos notificação hoje
            localStorage.setItem('lastNotificationDate', today);

            notification.onclick = () => {
                window.focus();
                notification.close();
            };

            // Fechar automaticamente após 10 segundos
            setTimeout(() => notification.close(), 10000);
        } catch (error) {
            console.error("Erro ao mostrar notificação:", error);
            // Fallback: mostrar notificação in-app
            showInAppReminder();
        }
    }
}

// Mostrar lembrete dentro do aplicativo
function showInAppReminder() {
    // Verificar se já mostramos notificação hoje
    const lastNotificationDate = localStorage.getItem('lastNotificationDate');
    const today = new Date().toDateString();
    
    if (lastNotificationDate === today) return;

    // Verificar se há transações hoje
    if (!checkTodysActivity()) {
        const reminder = document.createElement('div');
        reminder.className = 'in-app-reminder';
        reminder.innerHTML = `
            <div class="reminder-content">
                <i class="fas fa-bell"></i>
                <span>Não se esqueça de registrar suas finanças hoje!</span>
                <button class="close-reminder">&times;</button>
            </div>
        `;
        
        document.body.appendChild(reminder);
        
        // Marcar que mostramos notificação hoje
        localStorage.setItem('lastNotificationDate', today);
        
        // Fechar a notificação após 10 segundos
        setTimeout(() => {
            reminder.style.opacity = '0';
            setTimeout(() => reminder.remove(), 300);
        }, 10000);
        
        // Fechar ao clicar no botão
        reminder.querySelector('.close-reminder').addEventListener('click', () => {
            reminder.style.opacity = '0';
            setTimeout(() => reminder.remove(), 300);
        });
    }
}

// Verificar atividade hoje
function checkTodaysActivity() {
    const today = new Date().toDateString();
    return transactions.some(t => {
        const transactionDate = new Date(t.date).toDateString();
        return transactionDate === today;
    });
}

// ============================================
// FUNÇÕES UTILITÁRIAS (ORIGINAIS)
// ============================================

// Adicionar transações de exemplo
function addSampleData() {
    if (transactions.length === 0) {
        const today = new Date();
        const lastMonth = new Date();
        lastMonth.setMonth(today.getMonth() - 1);
        
        transactions = [
            { 
                id: today.getTime(), 
                description: "Salário", 
                category: "Salário", 
                value: 5000, 
                type: "income",
                date: today.toISOString().split('T')[0]
            },
            { 
                id: lastMonth.getTime(), 
                description: "Freelance", 
                category: "Freelance", 
                value: 1500, 
                type: "income",
                date: lastMonth.toISOString().split('T')[0]
            },
            { 
                id: today.getTime(), 
                description: "Aluguel", 
                category: "Moradia", 
                value: -1200, 
                type: "expense", 
                paga: false,
                date: today.toISOString().split('T')[0]
            },
            { 
                id: today.getTime(), 
                description: "Supermercado", 
                category: "Alimentação", 
                value: -450, 
                type: "expense", 
                paga: true,
                date: today.toISOString().split('T')[0]
            },
            { 
                id: today.getTime(), 
                description: "Transporte", 
                category: "Transporte", 
                value: -300, 
                type: "expense", 
                paga: false,
                date: today.toISOString().split('T')[0]
            },
            { 
                id: today.getTime(), 
                description: "Cinema", 
                category: "Lazer", 
                value: -150, 
                type: "expense", 
                paga: true,
                date: today.toISOString().split('T')[0]
            }
        ];
        saveTransactions();
        updateUI();
    }
}

// Função para voltar ao topo com animação suave
function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

// Verifica a posição de rolagem para mostrar/ocultar o botão
function toggleBackToTopButton() {
    if (window.scrollY > 300) {
        backToTopBtn.classList.add('visible');
    } else {
        backToTopBtn.classList.remove('visible');
    }
}

// Configurar botão de reset de dados
function setupResetDataButton() {
    const resetBtn = document.getElementById('reset-all-data');
    let confirmationStage = 0;
    let originalText = '';
    
    resetBtn.addEventListener('click', function() {
        if (confirmationStage === 0) {
            // Primeira confirmação
            originalText = resetBtn.innerHTML;
            resetBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Clique novamente para confirmar';
            resetBtn.classList.add('confirm-reset');
            confirmationStage = 1;
            
            // Resetar após 5 segundos se não confirmar
            setTimeout(() => {
                if (confirmationStage === 1) {
                    resetBtn.innerHTML = originalText;
                    resetBtn.classList.remove('confirm-reset');
                    confirmationStage = 0;
                }
            }, 5000);
        } 
        else if (confirmationStage === 1) {
            // Segunda confirmação - modal final
            const confirmed = confirm('ATENÇÃO: Isso apagará TODOS os seus registros permanentemente.\n\nDigite "APAGAR" para confirmar:');
            
            if (confirmed) {
                const userInput = prompt('Digite "APAGAR" para confirmar a exclusão de TODOS os dados:');
                
                if (userInput && userInput.toUpperCase() === 'APAGAR') {
                    // Resetar tudo
                    localStorage.removeItem('financialTransactions');
                    localStorage.removeItem('recurringTransactions');
                    localStorage.removeItem('notificationSettings');
                    localStorage.removeItem('financialGoals');
                    transactions = [];
                    recurringTransactions = [];
                    financialGoals = [];
                    
                    // Recarregar a página para limpar completamente
                    window.location.reload();
                } else {
                    alert('Cancelado. Seus dados permanecem intactos.');
                }
            }
            
            // Resetar o botão
            resetBtn.innerHTML = originalText;
            resetBtn.classList.remove('confirm-reset');
            confirmationStage = 0;
        }
    });
}

// ============================================
// FUNÇÕES DA CALCULADORA (ORIGINAIS)
// ============================================

// Elementos da calculadora
const calculatorToggle = document.getElementById('calculator-toggle');
const calculatorContainer = document.getElementById('calculator-container');
const calculatorDisplay = document.getElementById('calculator-display');
const calculatorButtons = document.querySelectorAll('.calc-btn');

// Variáveis de estado da calculadora
let currentInput = '0';
let previousInput = '';
let operation = null;
let resetScreen = false;

// Mostrar/ocultar calculadora
calculatorToggle.addEventListener('click', (e) => {
    e.stopPropagation();
    calculatorContainer.classList.toggle('show');
});

// Fechar calculadora ao clicar fora
document.addEventListener('click', (e) => {
    if (!calculatorContainer.contains(e.target) && 
        e.target !== calculatorToggle && 
        !calculatorToggle.contains(e.target)) {
        calculatorContainer.classList.remove('show');
    }
});

// Função para copiar para área de transferência
function copyToClipboard() {
    const valueToCopy = calculatorDisplay.getAttribute('data-copy-value') || '0';
    
    navigator.clipboard.writeText(valueToCopy).then(() => {
        // Feedback visual
        const originalText = calculatorDisplay.textContent;
        calculatorDisplay.textContent = "Copiado!";
        if (navigator.vibrate) navigator.vibrate(50); // Vibração para mobile
        
        setTimeout(() => {
            calculatorDisplay.textContent = originalText;
        }, 1000);
    }).catch(err => {
        console.error('Falha ao copiar: ', err);
        calculatorDisplay.textContent = "Erro ao copiar";
        setTimeout(() => {
            calculatorDisplay.textContent = valueToCopy;
        }, 1000);
    });
}

// Funções da calculadora
function handleNumberInput(number) {
    if (currentInput === '0' || resetScreen) {
        currentInput = number === '.' ? '0.' : number;
        resetScreen = false;
    } else {
        if (number === '.' && currentInput.includes('.')) return;
        currentInput += number;
    }
}

function handleOperation(op) {
    if (currentInput === '0' && previousInput === '') return;
    
    if (operation !== null) {
        calculate();
    }
    
    previousInput = currentInput;
    operation = op;
    resetScreen = true;
}

function clearCalculator() {
    currentInput = '0';
    previousInput = '';
    operation = null;
    resetScreen = false;
}

function toggleSign() {
    currentInput = (parseFloat(currentInput) * -1).toString();
}

function calculatePercentage() {
    currentInput = (parseFloat(currentInput) / 100).toString();
}

function calculate() {
    if (operation === null || resetScreen) return;
    
    const prev = parseFloat(previousInput);
    const current = parseFloat(currentInput);
    let result;
    
    try {
        switch (operation) {
            case '+':
                result = prev + current;
                break;
            case '-':
                result = prev - current;
                break;
            case '*':
                result = prev * current;
                break;
            case '/':
                if (current === 0) throw "Division by zero";
                result = prev / current;
                break;
            default:
                return;
        }
        
        currentInput = result.toString();
        operation = null;
        resetScreen = true;
    } catch (error) {
        currentInput = "Erro";
        setTimeout(() => {
            clearCalculator();
            updateDisplay();
        }, 1000);
    }
}

function updateDisplay() {
    let displayValue = currentInput;
    
    // Tratar números muito grandes
    if (displayValue.length > 10 && displayValue !== "Erro") {
        const num = parseFloat(displayValue);
        if (!isNaN(num)) {
            if (Math.abs(num) > 999999999 || Math.abs(num) < 0.0000001) {
                displayValue = num.toExponential(4);
            } else {
                displayValue = num.toPrecision(8).replace(/(\.0*|(?<=\.\d*?)0*)$/, '');
            }
        }
    }
    
    calculatorDisplay.textContent = displayValue;
    calculatorDisplay.setAttribute('data-copy-value', displayValue);
}

// Event listeners para botões da calculadora
calculatorButtons.forEach(button => {
    // Clique tradicional
    button.addEventListener('click', handleButtonInteraction);
    
    // Toque para dispositivos móveis
    button.addEventListener('touchend', handleButtonInteraction);
});

function handleButtonInteraction(e) {
    e.stopPropagation();
    e.preventDefault();
    
    const button = e.currentTarget;
    const value = button.getAttribute('data-value');
    const action = button.getAttribute('data-action');
    
    // Feedback visual
    button.classList.add('active-touch');
    setTimeout(() => button.classList.remove('active-touch'), 200);
    
    if (action === 'copy') {
        copyToClipboard();
        return;
    }
    
    if (!isNaN(value) || value === '.') {
        handleNumberInput(value);
    } else {
        switch (value) {
            case 'C':
                clearCalculator();
                break;
            case '±':
                toggleSign();
                break;
            case '⌫':
                handleBackspace();
                break;
            case '%':
                calculatePercentage();
                break;
            case '=':
                calculate();
                break;
            default:
                handleOperation(value);
        }
    }
    updateDisplay();
}

function handleBackspace() {
    if (currentInput.length === 1 || (currentInput.length === 2 && currentInput.startsWith('-'))) {
        currentInput = '0';
    } else {
        currentInput = currentInput.slice(0, -1);
    }
}

// Suporte a teclado para calculadora
document.addEventListener('keydown', (e) => {
    if (!calculatorContainer.classList.contains('show')) return;
    
    const key = e.key;
    
    // Mapeia teclas para ações da calculadora
    const keyMap = {
        '0': '0', '1': '1', '2': '2', '3': '3', '4': '4',
        '5': '5', '6': '6', '7': '7', '8': '8', '9': '9',
        '.': '.', ',': '.',
        '+': '+', '-': '-', '*': '*', 'x': '*', 'X': '*',
        '/': '/', '÷': '/',
        'Enter': '=', '=': '=',
        'Escape': 'C', 'Delete': 'C',
        'Backspace': '⌫',
        '%': '%',
        'c': 'copy', 'C': 'copy' // Tecla 'c' para copiar
    };
    
    if (key in keyMap) {
        e.preventDefault();
        const mappedValue = keyMap[key];
        
        if (mappedValue === 'copy') {
            copyToClipboard();
            return;
        }
        
        // Encontra o botão correspondente e simula clique
        const button = document.querySelector(`.calc-btn[data-value="${mappedValue}"]`);
        if (button) {
            button.click();
            button.classList.add('active-key');
            setTimeout(() => button.classList.remove('active-key'), 200);
        }
    }
});

// Inicializar display da calculadora
updateDisplay();

// ============================================
// EVENT LISTENERS
// ============================================

// Event listeners para transações
addIncomeBtn.addEventListener('click', () => {
    addTransaction('income');
});

addExpenseBtn.addEventListener('click', () => {
    addTransaction('expense');
});

exportPdfBtn.addEventListener('click', exportToPDF);
exportJsonBtn.addEventListener('click', exportToJSON);
updateBtn.addEventListener('click', updateTransaction);
cancelBtn.addEventListener('click', cancelEditMode);
shareWhatsappBtn.addEventListener('click', shareOnWhatsApp);

// Botões mobile
mobilePdfBtn.addEventListener('click', exportToPDF);
mobileJsonBtn.addEventListener('click', exportToJSON);
mobileImportBtn.addEventListener('click', () => {
    fileNameDisplay.textContent = "Nenhum arquivo selecionado";
    confirmImportBtn.disabled = true;
    importOverlay.style.display = 'flex';
});
mobileWhatsappBtn.addEventListener('click', shareOnWhatsApp);

// Importação de dados
importDataBtn.addEventListener('click', () => {
    fileNameDisplay.textContent = "Nenhum arquivo selecionado";
    confirmImportBtn.disabled = true;
    importOverlay.style.display = 'flex';
});

closeImportModal.addEventListener('click', () => {
    importOverlay.style.display = 'none';
});

cancelImportBtn.addEventListener('click', () => {
    importOverlay.style.display = 'none';
});

// Ao mudar a categoria, esconder qualquer erro
categoryInput.addEventListener('change', hideCategoryError);

// Opções de importação
document.querySelectorAll('input[name="import-option"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
        importOption = e.target.value;
    });
});

// Seleção de arquivo para importação
importFileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        fileNameDisplay.textContent = file.name;
        confirmImportBtn.disabled = false;
    } else {
        fileNameDisplay.textContent = "Nenhum arquivo selecionado";
        confirmImportBtn.disabled = true;
    }
});

// Confirmação de importação
confirmImportBtn.addEventListener('click', () => {
    const file = importFileInput.files[0];
    if (file) {
        importFromJSON(file, importOption);
    }
});

// Botão voltar ao topo
backToTopBtn.addEventListener('click', scrollToTop);
window.addEventListener('scroll', toggleBackToTopButton);

// Event listeners para notificações
enableNotificationsCheckbox.addEventListener('change', async (e) => {
    notificationEnabled = e.target.checked;
    notificationFrequencyDiv.style.display = notificationEnabled ? 'flex' : 'none';
    saveNotificationSettings();
    
    if (notificationEnabled) {
        await setupNotifications();
    } else {
        if (notificationInterval) {
            clearInterval(notificationInterval);
            notificationInterval = null;
        }
    }
});

reminderFrequencySelect.addEventListener('change', async (e) => {
    notificationFrequency = e.target.value;
    saveNotificationSettings();
    if (notificationEnabled) {
        await setupNotifications();
    }
});

reminderTimeInput.addEventListener('change', async (e) => {
    notificationTime = e.target.value;
    saveNotificationSettings();
    if (notificationEnabled) {
        await setupNotifications();
    }
});

// Controle do painel de notificações
const notificationToggle = document.getElementById('notification-toggle');
const notificationOptions = document.getElementById('notification-options');

notificationToggle.addEventListener('click', (e) => {
    e.stopPropagation();
    notificationOptions.classList.toggle('show');
});

// Fechar ao clicar fora
document.addEventListener('click', (e) => {
    if (!notificationOptions.contains(e.target) && e.target !== notificationToggle) {
        notificationOptions.classList.remove('show');
    }
});

// ============================================
// INICIALIZAÇÃO DA APLICAÇÃO
// ============================================

document.addEventListener('DOMContentLoaded', () => {
    // Inicializar data
    initializeDate();
    
    // Configurar abas
    setupTabs();
    
    // Configurar modal de transações recorrentes
    setupRecurringModal();
    
    // Configurar seletor de período
    setupPeriodSelector();
    
    // Configurar modal de metas
    setupGoalModal();
    
    // Carregar dados
    loadTransactions();
    loadRecurringTransactions();
    loadFinancialGoals();
    
    // Configurar categorias
    populateCategories();
    
    // Configurar notificações
    loadNotificationSettings();
    
    // Adicionar dados de exemplo (opcional - descomente se quiser)
    // addSampleData();
    
    // Configurar botão de reset
    setupResetDataButton();
    
    // Inicializar botão de voltar ao topo
    toggleBackToTopButton();
    
    // Verificar se é hora da notificação ao carregar a página
    if (notificationEnabled && Notification.permission === "granted") {
        const [hours, minutes] = notificationTime.split(':').map(Number);
        const now = new Date();
        
        // Se já passou do horário hoje e ainda não mostramos notificação
        if ((now.getHours() > hours || (now.getHours() === hours && now.getMinutes() >= minutes)) &&
            localStorage.getItem('lastNotificationDate') !== new Date().toDateString()) {
            showNotification();
        }
    }
});
</script>
</body>
</html>
